We will start by taking derivatives of the regularizer term $\ell_R$. First we
notice that we can write this term as
\begin{equation*}
	\ell_R = \frac{1}{2}\Vert\bgamma\Vert_{R}^2 = 
	\sum_i \ell_{R_i}
\end{equation*}
with $\ell_{R_i}=1/2\Vert\bgamma_i\Vert_{R_i}^2$. Therefore computing
derivatives of $\ell_R$ can be performed by taking derivatives of each
$\ell_{R_i}$ separately. Dropping contact subindex $i$ for simplicity, we write the regularization as
\begin{eqnarray*}
	\ell_R = \frac{1}{2}\Vert\bgamma\Vert_R^2=\frac{1}{2}(R_t\Vert\bgamma_t\Vert^2+R_n\gamma_n^2).
\end{eqnarray*}

In \textbf{stiction} $\bgamma=\vf{y}$ and the cost can be written as
\begin{eqnarray*}
	\ell_R(\vf{y}) = \frac{1}{2}(R_t y_r^2+R_n y_n^2).
\end{eqnarray*}

During \textbf{sliding} Eq. (\ref{eq:analytical_y_projection}) states that Coulomb's law applies and we can write
\begin{align*}
	\ell_R(\vf{y})
	&=\frac{1}{2}\gamma_n^2(R_t\mu^2+R_n)\\
	&=\frac{R_n}{2}(1+\tilde\mu^2)\gamma_n^2\\
	&=\frac{R_n}{2(1+\tilde\mu^2)}\left(y_n + \hat\mu y_r\right)^2,
\end{align*}
with $\tilde{\mu}=\mu (R_t/R_n)^{1/2}$ and $\hat{\mu}=\mu R_t/R_n$. Finally when there is \textbf{no contact}
\begin{eqnarray*}
	\ell_R(\vf{y}) = 0
\end{eqnarray*}

In total, $\ell_R$ is the piecewise function
\begin{align}
	&\ell_R(\vf{y}) = 
	\label{eq:ell_R_piecewise}\\	
&\begin{dcases}
	% Region I, stiction
	\frac{1}{2}(R_t y_r^2+R_n y_n^2) & \text{stiction, } y_r \le \mu y_n\\
	% Region II, sliding.
	\frac{R_n}{2(1+\tilde\mu^2)}\left(y_n + \hat\mu y_r\right)^2 & \text{sliding, } -\hat\mu y_r < y_n \leq \frac{y_r}{\mu}\\
	% Region II, no contact.
    \vf{0} & \text{no contact, } y_n < -\hat\mu y_r
\end{dcases}\nonumber	
\end{align}

\subsection{Gradients per Contact Point}
Since $\nabla_{\vf{y}_j}\ell_{R_i}=\vf{0}$ for $i\neq j$, we only need to
compute the gradients of $\ell_{R_i}(\mf{y})$ with respect to the contact point
variable $\vf{y}_i\in\mathbb{R}^3$. Unless otherwise stated, we'll drop the
subindex $i$. Therefore $\nabla_\vf{y}\ell_R\in\mathbb{R}^3$ and
$\nabla_\vf{y}^2\ell_R\in\mathbb{R}^{3\times 3}$ (notice that as per our
notation, we consistently use a bold italic font for 3D vectors and only bold,
not italic, for $n\text{-dimensional}$ vectors.) The full gradient
$\nabla_\mf{y}\ell_R$ concatenates the three-dimensional gradients
$\nabla_\vf{y}\ell_R$ while the full Hessian matrix is block-diagonal with each
$3\times 3$ block containing the local $i\text{-th}$ point Hessian.

We use the following identities to simplify expressions
\begin{eqnarray}
	\frac{\partial y_r}{\partial\vf{y}_t} &=& \hat{\vf{t}}\nonumber\\
	\frac{\partial \hat{\vf{t}}}{\partial\vf{y}_t} &=&
	\frac{\vf{P}^\perp(\hat{\vf{t}})}{y_r}
	\label{eq:yt_derivatives}
\end{eqnarray}
where the $2\times 2$ projection matrices along and perpendicular to
$\hat{\vf{t}}$ are defined as
\begin{eqnarray}
	\vf{P}(\hat{\vf{t}}) &=& \hat{\vf{t}}\otimes\hat{\vf{t}}\nonumber\\
	\vf{P}^\perp(\hat{\vf{t}})&=&\vf{I}_2 - \vf{P}(\hat{\vf{t}})
	\label{eq:tangential_projections}
\end{eqnarray}

Taking the gradient of Eq. (\ref{eq:ell_R_piecewise}) results in
\begin{align}
	&\nabla_\vf{y}\ell_R(\vf{y}) = 
	\label{eq:gradient_ell_R_piecewise}\\
&\begin{dcases}
	%%%%%%%%%%%%%%%%%%%%
	% Region I, stiction
	\vf{R}\,\vf{y} & 
	% when,
	\text{stiction, } y_r \le \mu y_n\\
	%
	%%%%%%%%%%%%%%%%%%%%
	% Region II, sliding.
	\frac{1}{1+\tilde\mu^2}\hat{s}^\circ(\vf{y})\begin{bmatrix}
		\mu R_t\hat{\vf{t}}\\
		R_n\\
	\end{bmatrix} &
	% when,
	\text{sliding, } -\hat\mu y_r < y_n \leq \frac{y_r}{\mu}\\
	% Region II, no contact.
    \vf{0} & \text{no contact, } y_n < -\hat\mu y_r
\end{dcases}\nonumber
\end{align}
with $\hat{s}^\circ(\vf{y}) = \hat{\mu}y_r+y_n$. $\hat{s}^\circ(\vf{y})$, a
measure of how close the solution is to the polar cone $\mathcal{F}^\circ$.
$\hat{s}^\circ(\vf{y}) > 0$ in the sliding region and $\hat{s}^\circ<0$ when
there is no contact. 

We note that $\nabla_\vf{y}\ell_R(\vf{y})$ is not differentiable at the
boundaries of $\mathcal{F}$ and $\mathcal{F}^\circ$. Therefore we define the
matrix $\vf{H}_R$ that returns the Hessian $\nabla_\vf{y}^2\ell_R(\vf{y})$ at
points of differentiability and it extends analytically on points of
non-differentiability as
\begin{align}
	&\vf{H}_R(\vf{y}) = 
	\label{eq:hessian_ell_R_piecewise}\\
&\begin{dcases}
	%%%%%%%%%%%%%%%%%%%%
	% Region I, stiction
	\vf{R} & 
	% when,
	\text{stiction,}\\
	%
	%%%%%%%%%%%%%%%%%%%%
	% Region II, sliding.
	\frac{R_n}{1+\tilde\mu^2}
	\begin{bmatrix}
		% ∂²ℓ/∂yₜ²:
		\hat{\mu}\left(\hat{\mu}\vf{P}(\hat{\vf{t}})+\hat{s}^\circ(\vf{y})\vf{P}^\perp(\hat{\vf{t}})/y_r\right) & 
		% ∂²ℓ/∂yₙ∂yₜ:
		\hat{\mu}\vf{t}\\
		% ∂²ℓ/∂yₜ∂yₙ:
		\hat{\mu}\vf{t}^T & 
		% ∂²ℓ/∂yₙ²:
		1\\
	\end{bmatrix} &
	% when,
	\text{sliding,}\\
	% Region II, no contact.
    \vf{0} & \text{no contact.}
\end{dcases}\nonumber
\end{align}
where the Hessian at differentiable points is computed by taking derivatives of
Eq. (\ref{eq:gradient_ell_R_piecewise}).

Clearly in the stiction region we have $\vf{H}_R(\vf{y})\succ 0$.
Since in the stiction region we have $\hat{s}^\circ(\vf{y})>0$, the linear
combination of $\vf{P}(\hat{\vf{t}})$ and $\vf{P}(\hat{\vf{t}})^\perp$ in Eq.
(\ref{eq:hessian_ell_R_piecewise}) is PSD (since both projection matrices are
PSD). Therefore, in the sliding region we find out that
$\vf{H}_R(\vf{y})\succeq 0$.

\subsection{Gradients with Respect to Velocities}
These gradients are computed using the chain rule and the definition of $\mf{y}$
\begin{equation*}
	\mf{y}=-\mf{R}^{-1}(\mf{J}\mf{v} - \hat{\mf{v}}_c)
\end{equation*}

Therefore the gradient in terms of velocities is
\begin{equation}
	\nabla_\mf{v}\ell_R = -\mf{J}^T\mf{R}^{-1}\nabla_\mf{y}\ell_R
	\label{eq:ell_velocity_gradient}
\end{equation}
which, using Eq. (\ref{eq:gradient_ell_R_piecewise}), can be written as
\begin{equation}
	\nabla_\mf{v}\ell_R = -\mf{J}^T\bgamma
	\label{eq:ell_velocity_gradient_simplified}
\end{equation}

We obtain the Hessian of the regularizer $\ell_R(\mf{v})$ from the
gradients of $\bgamma(\mf{v})$ in Eq. \eqref{eq:ell_velocity_gradient_simplified}
\begin{eqnarray}
	\nabla_\mf{v}^2\ell_R(\mf{v}) &=& \mf{J}^T\mf{G}\,\mf{J}\nonumber\\
	\mf{G} &=&-\nabla_{\mf{v}_c}\bgamma = \nabla_\mf{y}\bgamma \mf{R}^{-1}
	\label{eq:ellR_hessian}
\end{eqnarray}
where $\nabla_{\mf{v}_c}\!\bgamma$ is a block diagonal matrix where each
diagonal block is the $3\times 3$ matrix $\nabla_{\mf{v}_{c,i}}\!\bgamma_i$
for the $i\text{-th}$ contact.

Alternatively, taking the gradient of Eq. \eqref{eq:ell_velocity_gradient} leads to the equivalent result
\begin{equation}
	\nabla_\mf{v}^2\ell_R = \mf{J}^T\mf{R}^{-1}\nabla_\mf{y}^2\ell_R\mf{R}^{-1}\mf{J}
	\label{eq:ell_velocity_hessian}
\end{equation}
and since we already showed $\nabla_\mf{y}^2\ell_R\succeq 0$, it follows that
$\nabla_\mf{v}^2\ell_R\succeq 0$.


\subsection{Gradients of the Primal Cost}
With these results, we can now write the gradient and Hessian of the primal cost
$\ell_p(\mf{v})$ in Eq. (\ref{eq:primal_unconstrained}). For the gradient we
have
\begin{equation}
	\nabla_\mf{v}\ell_p(\mf{v}) = \mf{A}(\mf{v}-\mf{v}^*) + \nabla_\mf{v}\ell_R
\end{equation}

Notice that, using Eq. (\ref{eq:ell_velocity_gradient_simplified}), the gradient
can be written as
\begin{equation}
	\nabla_\mf{v}\ell_p(\mf{v}) = \mf{A}(\mf{v}-\mf{v}^*) - \mf{J}^T\bgamma
\end{equation}
and since the unconstrained minimization looks for $\nabla_\mf{v}\ell_p=\mf{0}$,
we essentially recover the balance of momentum, as expected.

Similarly, we can write the Hessian as
\begin{equation}
	\mf{H} = \nabla_\mf{v}^2\ell_p(\mf{v}) = \mf{A} + \nabla_\mf{v}^2\ell_R
\end{equation}
and since we already proved that $\nabla_\mf{v}^2\ell_R\succeq 0$, we find that
 $\mf{H}\succ 0$. Finally, we observe we are using the same analytical
 extensions used to defined $\nabla_\mf{v}^2\ell_R$ at points of
 non-differentiability.
