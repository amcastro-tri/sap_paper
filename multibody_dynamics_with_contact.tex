% Dummy comment so that file shows in Reviewable.

\section{Multibody Dynamics with Contact}
\label{sec:multibody_dynamics_with_contact}

We use generalized coordinates to describe our multibody system. Therefore, the
state is fully described by the generalized positions
$\mf{q}\in\mathbb{R}^{n_q}$ and the generalized velocities
$\mf{v}\in\mathbb{R}^{n_v}$, where $n_q$ and $n_v$ denote the number of
generalized positions and velocities, respectively.

Time derivatives of the generalized positions are described by the kinematic map
\begin{equation}
	\dot{\mf{q}} = \mf{N}(\mf{q})\mf{v}
	\label{eq:kinematic_map}
\end{equation}
where $\mf{N}(\mf{q})\in\mathbb{R}^{n_q\times n_v}$ is a block diagonal matrix.
For robotic systems comprised of revolute and prismatic joints, the blocks of
$\mf{N}(\mf{q})$ correspond to identity maps. The same is true for deformable
body models where the configuration is described by the position of each
vertex in a deformable mesh. For systems containing ball joints, free floating
bodies, or mobile bases, where either quaternions or Euler angles are used,
$\mf{N}(\mf{q})$ will contain non-identity blocks that are in general functions
of the configuration $\mf{q}$.

Given a configuration $\mf{q}$ of the system, our geometry engine reports a
discrete set of $n_c$ contacts between a pair of bodies. The $i\text{-th}$
\emph{contact pair} is described by the location $\vf{p}_i$ of the contact
point, a normal direction $\hat{\vf{n}}_i$ and the \emph{signed distance} or
\emph{gap function} $\phi_i(\mf{q})\in\mathbb{R}$. The kinematics of each
contact is further completed with the relative velocity
$\vf{v}_{c,i}\in\mathbb{R}^3$ between these two bodies at point $\vf{p}_i$,
expressed in a contact frame $C_i$ for which we arbitrarily choose the
$z\text{-axis}$ to coincide with the contact normal $\hat{\vf{n}}_i$.

We form the vector $\mf{v}_{c}\in\mathbb{R}^{3n_c}$ of contact velocities by
stacking velocities $\vf{v}_{c,i}$ of all contact pairs together. Similarly, we
denote by $\bgamma_i\in\mathbb{R}^3$ the contact impulse in the contact frame $C_i$ at a specific contact
point and with $\bgamma\in\mathbb{R}^{3n_c}$ the stacked vector of all contact impulses.
In general, unless otherwise specified, we use bold italics for vectors in
$\mathbb{R}^3$ and non-italics bold for their stacked counterpart. The
generalized velocities $\mf{v}$ and contact velocities $\mf{v}_c$ satisfy the
equation $\mf{v}_c=\mf{J}\,\mf{v}$, where
$\mf{J}(\mf{q})\in\mathbb{R}^{3n_c\times n_v}$ denotes the contact Jacobian.

To arrive at a discrete time system of equations, we can integrate the
momentum balance at intervals of size $\delta t$ from time step $t^n$ to the
next time step $t^{n+1}=t^n+\delta t$. We write this as
\begin{eqnarray}
	\mf{M}(\mf{v}^{n+1}-\mf{v}^n)  = \delta t\,\bar{\vf{\tau}} + \mf{J}^T\mf{\bgamma},
	\label{eq:momentum_balance}
\end{eqnarray}
where $\mf{M}(\mf{q})\in\mathbb{R}^{n_v\times n_v}$ is the mass matrix and
$\bar{\vf{\tau}}\in\mathbb{R}^{n_v}$ models external forces such as gravity and
gyroscopic terms arising in multibody dynamics.
We present a
comprehensive discussion of our discrete time-stepping scheme in Section
\ref{sec:discrete_time_formulation}.

Denoting with $\gamma_{n,i} \in \mathbb{R}$ and with $\bgamma_{t,i} \in
\mathbb{R}^2$ the normal and tangential components of the impulse
$\bgamma_i=[\bgamma_{t,i}\,\gamma_{n,i}]$ in frame $C_i$, the formulation is
most often completed with the following set of standard constraints to be
satisfied at each contact
\begin{enumerate}
	\item non-penetration constraint $0\le\phi_i\perp\gamma_{n,i}\ge0$,
	\item\label{it:cone_constraint} friction cone constraint
	$\Vert\bgamma_{t,i}\Vert\le \mu_i\gamma_{n,i}$,
    where $\mu_i \in \mathbb{R}$ is the coefficient of friction for the
    $i\text{-th}$ contact, and
	\item the \emph{maximum dissipation principle}, which states that given the
	normal impulse, the friction impulse maximizes the rate of energy
	dissipation. In other words, friction impulses oppose the sliding velocity
	direction.
\end{enumerate}
Condition \ref{it:cone_constraint} states that contact
impulses $\bgamma_i$ at point $i$ are constrained to belong to the friction cone
$\mathcal{F}_i=\{[\vf{x}_t, x_n] \in\mathbb{R}^3 \,|\, \Vert\vf{x}_t\Vert\le
\mu_i x_n\}$.

While these constraints describe the widely used Colulomb friction model, the
resulting formulation leads to a very difficult to solve, non-convex, NCP.

\section{Convex Approximation of Contact Dynamics}
\label{sec:previous_work}

To ensure existence of a solution and improve computational tractability,
Anitescu introduces a \textit{convex approximation} of the contact
problem \cite{bib:anitescu2006}. In this approximation, the contact impulses are
solutions to the following convex optimization problem
\begin{eqnarray}
	\min_{\gamma\in \mathcal{F}} \ell(\bgamma) =
	\frac{1}{2}\bgamma^T\mathbf{W}\bgamma + {\bm r}^T
	\bgamma,
	\label{eq:dual_cost}
\end{eqnarray}
where $\mathbf{W} =
\mathbf{J}\mathbf{M}^{-1}\mathbf{J}^T\in\mathbb{R}^{3n_c\times 3n_c}$ is the
\emph{Delassus operator}, $\mathcal{F} := \mathcal{F}_1 \times F_2 \times \cdots
\times \mathcal{F}_{n_c}$ is a Cartesian product of friction cones, and ${\bm
r}$ defines a linear cost that encodes external force contributions and
stabilization terms used to impose non-penetration at the position level.

Further, \cite{bib:anitescu2006} uses a polyhedral approximation to linearize
the friction cone constraint $\bgamma_i\in\mathcal{F}_i$. In this work, we do not
linearize the cone constraints, but work directly with the second order cone
constraints. This approach is preferred given that the polyhedral
approximation is known to introduce non-physical anisotropy
\cite{bib:li2018implicit}. In addition, the linearization of the friction cone
results in a far larger problem due to the additional constraints
needed to represent the polyhedral cone.

Anitescu shows in \cite{bib:anitescu2006} that the optimality conditions for the
problem in Eq. (\ref{eq:dual_cost}) imply the conservation of momentum in Eq.
(\ref{eq:momentum_balance}), the maximum dissipation principle, and the modified
non-penetration condition
\begin{equation}
	0 \le \phi_i - \delta t \Vert {\bm v}_{t,i} \Vert \perp \gamma_{n,i} \ge 0
	\label{eq:convex_approximation_complementarity_condition}
\end{equation}
where $\vf{v}_{t,i}$ is the tangential component of the contact velocity
$\vf{v}_{c,i} = [\vf{v}_{t,i}\,v_{n,i}]$. Notice that the modified non-penetration
condition in Eq. (\ref{eq:convex_approximation_complementarity_condition}) 
introduces coupling with the sliding velocity, a
result of the convex approximation. We provide a detailed discussion on the
physical validity of this approximation in Section \ref{sec:physical_intuition},
along with guidelines for determining its applicability to robotic simulation.

In \cite{bib:todorov2011, bib:todorov2014} Todorov introduces regularization to
the formulation in Eq. (\ref{eq:dual_cost}). Though not strictly applicable to
contact problems, the \emph{Gauss's principle of least constraint} is used to
obtain the following regularized form of Anitescu's formulation
\begin{eqnarray}
	\min_{\gamma\in \mathcal{F}} \ell(\bgamma) =
	\frac{1}{2}\bgamma^T(\mathbf{W}+\mathbf{R})\bgamma + {\bm r}^T
	\bgamma,
	\label{eq:dual_regularized}
\end{eqnarray}
where $\mathbf{R}$ is a diagonal positive definite matrix introduced to make
$\mathbf{W}+\mathbf{R}\succ 0$ since in general we only have $\mathbf{W} \succeq
0$. This makes the problem strictly convex and thus a unique solution exists.
Regularization is used as a means to add constraint
stabilization with a set of global parameters that control the amount of numerical
compliance introduced by the formulation. This is different from our approach
described in Section \ref{sec:physical_intuition}, where we show how to use
regularization to model physical compliance, with well defined physical
parameters.
