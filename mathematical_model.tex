\section{Discrete Time Formulation}
Our discrete-time model is based on the $\theta\text{-method}$
\GreenHighlight{Add citation to this method} and incorporates the symplectic
midpoint rule to attain second-order accuracy. It takes the following form 
\begin{eqnarray}
	&&\mf{M}(\mf{q}^{\theta_{q}})(\mf{v}-\mf{v}_0) +
	dt\,\mf{F}(\mf{q}^{\theta_{q}}, \mf{v}^{\theta_v}) =
	\mf{J}(\mf{q}^{\theta_{q}})^T\mf{\bgamma}, \label{eq:v_update}\\
	&&\mf{q} = \mf{q}_0 + dt\mf{N}(\mf{q}^{\theta_{q}})\mf{v}^{\theta_{vq}},
	\label{eq:q_update}
\end{eqnarray}
where $(\mf{q}_0, \mf{v}_0)$ denote variables from the previous time-step. The
term $\mf{F}(\mf{q}, \mf{v})$ can include Coriolis and gyroscopic forces arising
in multibody dynamics, forces from modeling elements (such as springs and
dampers) and even internal forces for the modeling of soft-body deformation. The
\emph{mid-step quantities} $\mf{q}^{\theta_{q}}$, $\mf{v}^{\theta_{v}}$, and
$\mf{v}^{\theta_{vq}}$ are defined in accordance with the standard
$\theta\text{-method}$ using scalar parameters $\theta_q$ $\theta_v$ and
$\theta_{vq}$
\begin{eqnarray*}
	\mf{q}^{\theta_q} &=& \theta_q\mf{q} + (1-\theta_{q})\mf{q}_0,\\
	\mf{v}^{\theta_v} &=& \theta_v\mf{v} + (1-\theta_v)\mf{v}_0,\\
	\mf{v}^{\theta_{vq}} &=& \theta_{vq}\mf{v} + (1-\theta_{vq})\mf{v}_0.
\end{eqnarray*}
This form generalizes some of the most popular schemes for forward dynamics:
\begin{itemize}
	\item Explicit Euler with $\theta_q=\theta_{v}=\theta_{vq} = 0$,
	\item Symplectic Euler with $\theta_{q} = 0$ and $\theta_v = \theta_{vq}=1$,
	\item Implicit Euler with $\theta_{q} = \theta_v = \theta_{vq}= 1$,
	\item Symplectic midpoint rule, which is second order, with $\theta_{q} =
	\theta_v = \theta_{vq}= 1/2$,
\end{itemize}

Similar to the work in \cite{bib:duriez2005realistic} for the simulation of
deformable objects and to projection methods used in fluid mechanics
\cite{bib::bell1991efficient}, we solve Eqs. (\ref{eq:v_update}) and
(\ref{eq:q_update}) in two stages. In the first stage we solve for the
\textit{free motion} velocities $\mf{v}^*$ in the absence of constraint impulses
\begin{eqnarray}
	&&\mf{M}^*(\mf{v}^*-\mf{v}_0) + dt\,\mf{F}(\mf{q}^{\theta_q}(\mf{v}^*), \mf{v}^{\theta_v}(\mf{v}^*)) = \mf{0},
	\label{eq:vstar_definition}\\
	&&\mf{q}^{\theta_q}(\mf{v}^*) = \mf{q}_0 + dt\theta_q\mf{N}(\mf{q}^{\theta_{q}})\mf{v}^{\theta_{vq}}(\mf{v}^*),
	\label{eq:qstar_definition}
\end{eqnarray}
where $\mf{M}^* = \mf{M}(\mf{q}^{\theta_q}(\mf{v}^*))$. The explicit and
symplectic Euler schemes require inversion of the mass matrix $\mf{M}^*$ to
solve for $\mf{v}^*$. We can efficiently do this with the $\mathcal{O}(n)$
\emph{Articulated Body Algorithm}
\cite{bib:featherstone2008_rigid_body_dynamics_algorithms}. For non-linear
implicit schemes such as the implicit Euler and the midpoint rule, we use an
iterative method to solve for $\mf{v}^*$.

Notice that, in the
absence of constraint impulses, the next step velocity is $\mf{v}=\mf{v}^*$ and
it is computed with the order of accuracy of the $\theta\text{-method}$. We also
expect to recover the order of accuracy of the $\theta\text{-method}$ when
constraints do not produce work. For instance, for a rolling wheel the stiction
constraint does not dissipate energy since the slip velocity is zero even though
the friction force is non-zero, i.e. $\bgamma_t\cdot\mf{v}_t = 0$. Moreover, we
will see in Section XXX that the symplectic midpoint rule conserves energy
exactly during rolling.\RedHighlight{Alejandro: Add proper reference to the
billiard balls example in the numerical examples section.}

For the second stage we linearize Eq. (\ref{eq:v_update})
at $\mf{v} = \mf{v}^*$ to obtain a linearized balance of momentum
\begin{eqnarray}
	\mf{A}(\mf{v}-\mf{v}^*)= \mf{J}^T\mf{\gamma}
	\label{eq:momentum_linearized}
\end{eqnarray}
with
\begin{eqnarray}
	\mf{A}&=&\mf{M}+\theta_q\theta_{qv} dt^2\,\mf{K}+\theta_v dt\,\mf{D},
	\label{eq:expression_for_A}\\
	\mf{K}&=&\frac{\partial \mf{F}}{\partial \mf{q}}\Bigr|_{(\mf{q}^{\theta_q}, \mf{v}^{\theta_v})},\\
	\mf{D}&=&\frac{\partial \mf{F}}{\partial \mf{v}}\Bigr|_{(\mf{q}^{\theta_q},
	\mf{v}^{\theta_v})}.
	\label{eq:dissipation_matrix}
\end{eqnarray}
where the only assumption in Eq. (\ref{eq:expression_for_A}) is that the map
$\mf{N}(\mf{q})$ is the identity \GreenHighlight{Recommend never introducing N
if it is always the identity} which is commonly the case for degrees of freedom
used to model compliant elements. When $\mf{F}(\mf{q}, \mf{v})$ is linear the
stiffness matrix $\mf{K}$ and the damping matrix $\mf{D}$ are constant and the
two stage process described by Eqs. (\ref{eq:vstar_definition}) to
(\ref{eq:momentum_linearized}) is exact and solves the original problem stated
by Eq. (\ref{eq:v_update}).


A typical example of constant stiffness and damping is that of a spring-damper
model at a joint. In this case these matrices only contribute positive diagonal
elements to matrix $\mf{A}$.

An example of complex stiffness and damping matrices is when using a Finite
Element Model (FEM) of large soft body deformations. In this case $\mf{K}$ and
$\mf{D}$ are large sparse, positive definite, matrices.

Our convex approximation of contact requires $\mf{A}\succ 0$. Therefore only
compliant and dissipation elements that lead to positive definite matrices can
be included in Eq. (\ref{eq:expression_for_A}). This is the case for joint
spring-damper models and deformable models. It is not the case for Coriolis and
gyroscopic terms. These terms can still be treated implicitly in Eqs.
(\ref{eq:vstar_definition}) and (\ref{eq:qstar_definition}), but their
derivative is assumed to be zero in Eq. (\ref{eq:dissipation_matrix}), an
approximation only accurate to first order. \GreenHighlight{What does "treated
implicitly" mean? In what way is their derivative is zero in
\ref{eq:dissipation_matrix}? When you introduced $F(q,v)$ you said that it
already includes gyroscopic and Corolis terms, but this discussion seems to
about how to add them, as if they weren't already there...  }

