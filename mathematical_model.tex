\section{Discrete Time Formulation}
\label{sec:discrete_time_formulation}

Our discrete-time model is based on the $\theta\text{-method}$ \cite[\S
II.7]{bib:hairer2008solving} and incorporates the symplectic midpoint rule to
attain second order accuracy and energy conservation. While most of the work in
the literature uses first order time-stepping schemes, the extension to the
second-order midpoint rule is analyzed in \cite{bib:potra2006linearly}. While
the work in \cite{bib:potra2006linearly} uses a polyhedral approximation of the
friction cone that leads to an LCP formulation, our approach does not
approximate the friction cone but introduces the convex approximation of contact
from \cite{bib:anitescu2006} \RedHighlight{TODO: Introduce definition of LCP in
the introduction}. We remark that combining the $\theta\text{-method}$ with the
convex approximation of contact is novel to our work. 

Time is discretized into intervals of fixed size $dt$ and we seek to advance the
state of the system from time $t^n$ to the next step at $t^{n+1} = t^n + dt$. In
the $\theta\text{-method}$ variables are evaluated at intermediate time steps
$t^\theta = \theta t^{n+1}+(1-\theta)t^{n}$, with $\theta \in [0, 1]$. We define
\emph{mid-step quantities} $\mf{q}^{\theta_{q}}$, $\mf{v}^{\theta_{v}}$, and
$\mf{v}^{\theta_{vq}}$ in accordance with the standard $\theta\text{-method}$
using scalar parameters $\theta_q$ $\theta_v$ and $\theta_{vq}$
\begin{eqnarray}
	\mf{q}^{\theta_q} &=& \theta_q\mf{q} + (1-\theta_{q})\mf{q}_0,\nonumber\\
	\mf{v}^{\theta_v} &=& \theta_v\mf{v} + (1-\theta_v)\mf{v}_0,\nonumber\\
	\mf{v}^{\theta_{vq}} &=& \theta_{vq}\mf{v} + (1-\theta_{vq})\mf{v}_0.
	\label{eq:theta_method}
\end{eqnarray}

Using the above definitions, we write our discrete update in the following form
\begin{eqnarray}
	\mf{M}(\mf{q}^{\theta_{q}})(\mf{v}-\mf{v}_0)  &=& \nonumber\\
	dt\,\mf{F}(\mf{q}^{\theta_{q}}, \mf{v}^{\theta_v}) &+&
	dt\,\mf{G}(\mf{q}^{\theta_{q}}, \mf{v}^{\theta_v}) +
	\mf{J}(\mf{q}^{\theta_{q}})^T\mf{\bgamma}, \label{eq:v_update}\\
	\mf{q} = \mf{q}_0 + dt \dot{\mf{q}}^{\theta_{vq}} &=& \mf{q}_0 + dt\mf{N}(\mf{q}^{\theta_{q}})\mf{v}^{\theta_{vq}},
	\label{eq:q_update}
\end{eqnarray}
where to simplify notation $(\mf{q}_0, \mf{v}_0)$ denotes the state at $t^n$ and
$(\mf{q}, \mf{v})$ the state at $t^{n+1}$. $\mf{N}(\mf{q})$ is the kinematic map
defined in Eq. (\ref{eq:kinematic_map}). Notice that in the update for $\mf{q}$
we allow for the evaluation of $\mf{N}$ at $t^{\theta_{q}}$ and velocities
at $t^{\theta_{vq}}$. This will allow us to write fully implicit as well as
semi-implicit symplectic schemes within the same framework. For the common case
when $\mf{N}$ is the identity matrix, $\dot{\mf{q}}$ is evaluated at
$t^{\theta_{vq}}$, justifying the notation. Note that using Eq.
(\ref{eq:q_update}) the mid-step configuration $\mf{q}^{\theta_q}$ can be
written as
\begin{equation}
	\mf{q}^{\theta_q}(\mf{v}) = \mf{q}_0 + dt\theta_q\mf{N}(\mf{q}^{\theta_{q}})\mf{v}^{\theta_{vq}}(\mf{v})
	\label{eq:position_update}
\end{equation}


We split forces into two contributions so that $\partial \mf{F}/\partial\mf{q}$ and $\partial \mf{F}/\partial\mf{v}$ are positive definite matrices while the same is generally not true for the gradients of $\mf{G}$. Therefore in $\mf{F}(\mf{q}, \mf{v})$ we will include modeling elements such as spring and dampers and even internal forces
for the modeling of soft-body deformation. $\mf{G}(\mf{q}, \mf{v})$ will include
all other contributions that cannot guarantee positive definiteness of the
gradients such as Coriolis and gyroscopic forces arising in multibody dynamics with generalized coordinates.

The discrete update in Eqs. (\ref{eq:v_update})-(\ref{eq:q_update}) generalizes
some of the most popular schemes for forward dynamics:
\begin{itemize}
	\item Explicit Euler with $\theta_q=\theta_{v}=\theta_{vq} = 0$,
	\item Symplectic Euler with $\theta_{q} = 0$ and $\theta_v = \theta_{vq}=1$,
	\item Implicit Euler with $\theta_{q} = \theta_v = \theta_{vq}= 1$,
	\item Symplectic midpoint rule, which is second order, with $\theta_{q} =
	\theta_v = \theta_{vq}= 1/2$,
\end{itemize}

Similar to the work in \cite{bib:duriez2005realistic} for the simulation of
deformable objects and to projection methods used in fluid mechanics
\cite{bib::bell1991efficient}, we solve Eqs. (\ref{eq:v_update}) and
(\ref{eq:q_update}) in two stages; first we solve for the \emph{free motion
velocities} the system would have in the absence of contact and second, we
update these free motion velocities so that they satisfy conservation of
momentum along with contact constraints.

We first define the momentum quantity
\begin{multline}
	\mf{m}(\mf{v}) =
	\mf{M}(\mf{q}^{\theta_{q}}(\mf{v}))(\mf{v}-\mf{v}_0) -\\
	dt\,\mf{F}(\mf{q}^{\theta_{q}}(\mf{v}), \mf{v}^{\theta_v}(\mf{v}))-
	dt\,\mf{G}(\mf{q}^{\theta_{q}}(\mf{v}), \mf{v}^{\theta_v}(\mf{v}))
	\label{eq:m_definition}
\end{multline}

In the first stage we solve for the
\textit{free motion} velocities $\mf{v}^*$ in the absence of constraint impulses
\begin{eqnarray}
	\mf{m}(\mf{v}^*) &=& \mf{0},
	\label{eq:vstar_definition}
\end{eqnarray}

For the implicit Euler scheme and the midpoint rule, Eq.
(\ref{eq:vstar_definition}) is implicit in $\mf{v}^*$ and we solve them using
Newton's method. The explicit and symplectic Euler schemes require inversion of
the mass matrix $\mf{M}$, which can be accomplished efficiently using the
$\mathcal{O}(n)$
\emph{Articulated Body Algorithm}
\cite{bib:featherstone2008_rigid_body_dynamics_algorithms}.

For the second stage we linearize $\mf{m}(\mf{v})$ around $\mf{v} = \mf{v}^*$ to write an approximation of Eq. (\ref{eq:v_update}) as
\begin{eqnarray}
	\mf{A}(\mf{v}-\mf{v}^*)= \mf{J}^T\mf{\gamma}
	\label{eq:momentum_linearized}
\end{eqnarray}
with
\begin{eqnarray}
	\mf{A}&=&\mf{M}+dt^2\,\theta_q\theta_{qv}\mf{K}+dt\,\theta_v\mf{D},
	\label{eq:expression_for_A}\\
	\mf{K}(\mf{q}, \mf{v})&=&-\frac{\partial \mf{F}(\mf{q}, \mf{v})}{\partial
	\mf{q}}\frac{\partial\dot{\mf{q}}^{\theta_{vq}}}{\partial\mf{v}},
	\label{eq:stiffness_matrix}\\
	\mf{D}(\mf{q}, \mf{v})&=&-\frac{\partial \mf{F}(\mf{q}, \mf{v})}{\partial
	\mf{v}},
	\label{eq:dissipation_matrix}
\end{eqnarray}
where $\mf{K}$ and $\mf{D}$ are the stiffness and damping matrices of the
system, respectively. As an example, consider modeling spring-dampers at the
joint level. In this case $\mf{K}$ and $\mf{D}$ are constant and diagonal. A
more complex example arises when using a Finite Element Model (FEM) of soft body
deformations. In this case $\mf{K}$ and $\mf{D}$ are large sparse, positive
definite, matrices.

Equation (\ref{eq:momentum_linearized}) is a first order approximation of Eq.
(\ref{eq:v_update}) as stated in the following
\begin{theorem}	
	In the absence of impacts Eq. (\ref{eq:momentum_linearized}) is a first
	order approximation of Eq. (\ref{eq:v_update}). That is
	\begin{eqnarray}
		\mf{m}(\mf{v}) = \mf{A}(\mf{v}-\mf{v}^*) + \mathcal{O}(dt^2) =
		\mf{J}^T\mf{\bgamma}.
	\end{eqnarray}
Moreover, $\mf{A} \succ 0$.
\end{theorem}

\begin{IEEEproof}
The Taylor expansion of $\mf{m}(\mf{v})$ at $\mf{v}=\mf{v}^*$ reads
\begin{eqnarray}
	\mf{m}(\mf{v}) &=& \mf{m}^* +
	\nabla\mf{m}^*(\mf{v}-\mf{v}^*) + \mathcal{O}_m(\Vert\mf{v}-\mf{v}^*\Vert^2)\nonumber\\
	&=&\nabla\mf{m}^*(\mf{v}-\mf{v}^*) + \mathcal{O}_m(\Vert\mf{v}-\mf{v}^*\Vert^2)
	\label{eq:m_taylor_expansion}
\end{eqnarray}
where the superscript $^*$ denotes quantities evaluated at $\mf{v}^*$ and we use
the fact that by definition $\mf{m}^*=\mf{m}(\mf{v}^*)=\mf{0}$. The operator
$\nabla$ denotes the gradient with respect to $\mf{v}$.

We evaluate first the gradient of the mass matrix term in Eq.
(\ref{eq:m_definition}) using the chain rule through Eq.
(\ref{eq:position_update})
\begin{eqnarray}
	\nabla[\mf{M}(\mf{q}^{\theta_{q}}(\mf{v}))(\mf{v}-\mf{v}_0)]\Bigr|_{\mf{v}^*}
	= \mf{M}(\mf{q}^{\theta_{q}}(\mf{v}^*)) + \mf{E}^*,
\end{eqnarray}
where we defined
\begin{eqnarray}
	\mf{E}^* =
	dt\theta_q\frac{\partial[\mf{M}(\mf{q}^{\theta_{q}})(\mf{v}^*-\mf{v}_0)]}{\partial\mf{q}}\frac{\partial\dot{\mf{q}}^{\theta_{vq}}}{\partial\mf{v}}.
	\label{eq:E_definition}
\end{eqnarray}

Equation (\ref{eq:E_definition}) involves cumbersome derivatives of the mass matrix with respect to configurations. However, we can still see that $\mf{E}^*=\mathcal{O}(dt\Vert\mf{v}^*-\mf{v}_0\Vert)$ where we are using the big O notation to describe its limiting behavior as $dt\rightarrow 0$. Since the free motion dynamics that defines $\mf{v}^*$ is continuous, we know that $\Vert\mf{v}^*-\mf{v}_0\Vert = \mathcal{O}(dt)$ and therefore $\mf{E}^* = \mathcal{O}(dt^2)$.

We proceed similarly to expand the gradient of $\mf{F}(\mf{v})=\mf{F}(\mf{q}^{\theta_{q}}(\mf{v}), \mf{v}^{\theta_v}(\mf{v}))$ as
\begin{eqnarray}
	\nabla\mf{F} =
	-dt\,\theta_q\theta_{vq}\mf{K}(\mf{q}^{\theta_q}, \mf{v}^{\theta_v})-\theta_v\mf{D}(\mf{q}^{\theta_q}, \mf{v}^{\theta_v})
\end{eqnarray}
with $\mf{K}$ and $\mf{D}$ the stiffness and damping matrices defined by Eqs.
(\ref{eq:stiffness_matrix})-(\ref{eq:dissipation_matrix}).

We can now write the gradient of $\mf{m}(\mf{v})$ in Eq. (\ref{eq:m_taylor_expansion}) as
\begin{eqnarray}
	\nabla\mf{m}^* = \mf{A} + \mf{E}^* - dt\nabla\mf{G}
\end{eqnarray}
where we defined
\begin{eqnarray}
	\mf{A}=\mf{M}+ dt^2\theta_q\theta_{qv}\mf{K}+dt\theta_v\mf{D},
\end{eqnarray}

With these definitions the Taylor expansion in Eq. (\ref{eq:m_taylor_expansion})
becomes
\begin{multline}
	\nabla\mf{m}^*(\mf{v}-\mf{v}^*) =\\
	\mf{A}(\mf{v}-\mf{v}^*) + \mf{E}^*(\mf{v}-\mf{v}^*) - dt\,\nabla\mf{G}\,(\mf{v}-\mf{v}^*).
\end{multline}

In the absence of impacts $\Vert\mf{v}-\mf{v}^*\Vert=\mathcal{O}(dt)$. Therefore
$\mf{E}^*(\mf{v}-\mf{v}^*)=\mathcal{O}_E(dt^3)$ and
$dt\nabla\mf{G}(\mf{v}-\mf{v}^*)=\mathcal{O}_G(dt^2)$. Then the Taylor expansion
\begin{eqnarray}
	\mf{A}(\mf{v}-\mf{v}^*) + \mathcal{O}_E(dt^3) + \mathcal{O}_G(dt^2) = \mf{J}^T\mf{\bgamma}
\end{eqnarray}
is a first order approximation of the original momentum balance in Eq.
(\ref{eq:v_update}).

Finally, notice that $\mf{A}$ is a linear combination of positive definite
matrices with positive scalars in the linear combination, and therefore
$\mf{A}\succ 0$.

\end{IEEEproof}

We summarize our discrete time stepping strategy as follows
\begin{enumerate}
	\item Solve for the \emph{free motion} velocities $\mf{v}^*$, from Eq.
	(\ref{eq:vstar_definition}).
	\item Compute the SPD approximation of the gradient $\mf{A}$, as defined in
	Eq. (\ref{eq:expression_for_A}).
	\item\label{it:solve_for_contact} Solve for the constraint impulses $\bgamma$ that satisfy the
	linearized momentum Eq. (\ref{eq:momentum_linearized}) and the contact
	constraints. 
	\item Update the positions according to Eq. (\ref{eq:q_update}).
\end{enumerate}

Impulses in item \ref{it:solve_for_contact} are the solution to our convex
approximation of compliant contact described in the next section. Section
\ref{sec:sap_solver} presents the SAP solver to solve it in practice.


Notice that, in the absence of constraint impulses, the next step velocity is
$\mf{v}=\mf{v}^*$ and it is computed with the order of accuracy of the
$\theta\text{-method}$. We also expect to recover the properties of the
$\theta\text{-method}$ when contact constraints are not active. This is the case
of rolling friction for which the contact constraints behave as a bi-lateral
constraints to impose zero slip velocity. We demonstrate this in Section XXX
with an example simulation of billiard balls.  \RedHighlight{Alejandro: Add
proper reference to the billiard balls example in the numerical examples
section.}
