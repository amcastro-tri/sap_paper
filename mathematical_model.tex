\section{Discrete Time Formulation}
\label{sec:discrete_time_formulation}

Our discrete-time model is based on the $\theta\text{-method}$ \cite[\S
II.7]{bib:hairer2008solving}. In particular, it incorporates the symplectic
midpoint rule that attains second order accuracy and energy conservation. While
most of the work in the literature uses first order time-stepping schemes, the
extension to the second-order midpoint rule is analyzed in
\cite{bib:potra2006linearly}. In contrast to \cite{bib:potra2006linearly} which
uses a polyhedral approximation of the friction cone that leads to an LCP
formulation, our approach does not approximate the friction cone but introduces
the convex approximation of contact from \cite{bib:anitescu2006} instead. We
remark that combining the $\theta\text{-method}$ with the convex approximation
of contact is novel to our work. 

We discretize time into intervals of fixed size $\delta t$ and seek to advance the
state of the system from time $t^n$ to the next step at $t^{n+1} = t^n + \delta t$. In
the $\theta\text{-method}$, variables are evaluated at intermediate time steps
$t^\theta = \theta t^{n+1}+(1-\theta)t^{n}$, with $\theta \in [0, 1]$. We define
\emph{mid-step quantities} $\mf{q}^{\theta_{q}}$, $\mf{v}^{\theta_{v}}$, and
$\mf{v}^{\theta_{vq}}$ in accordance with the standard $\theta\text{-method}$
using scalar parameters $\theta_q$, $\theta_v$, and $\theta_{vq}$
\begin{align}
	\mf{q}^{\theta_q} &= \theta_q\mf{q} + (1-\theta_{q})\mf{q}_0,\nonumber\\
	\mf{v}^{\theta_v} &= \theta_v\mf{v} + (1-\theta_v)\mf{v}_0,\nonumber\\
	\mf{v}^{\theta_{vq}} &= \theta_{vq}\mf{v} + (1-\theta_{vq})\mf{v}_0,
	\label{eq:theta_method}
\end{align}
where, to simplify notation, we use $(\mf{q}_0, \mf{v}_0)$ to denote the state
at $t^n$ and $(\mf{q}, \mf{v})$ to denote the state at $t^{n+1}$.

Using these mid-step quantities, we write an approximation for the mean
generalized forces $\bar{\vf{\tau}}$ in Eq. (\ref{eq:momentum_balance}) as
\begin{equation*}
	\bar{\vf{\tau}} = \mf{F}(\mf{q}^{\theta_{q}}(\mf{v}), \mf{v}^{\theta_v}(\mf{v}))+
	\mf{G}(\mf{q}^{\theta_{q}}(\mf{v}), \mf{v}^{\theta_v}(\mf{v})),
\end{equation*}
where we split the forces into two contributions $\mf{F}$ and $\mf{G}$ so that
the Jacobians $\partial \mf{F}/\partial\mf{q}$ and $\partial
\mf{F}/\partial\mf{v}$ are negative definite matrices while the same is
generally not true for the Jacobians of $\mf{G}$. The term $\mf{F}(\mf{q},
\mf{v})$ can include forces from modeling elements such as spring and dampers and even
internal forces for the modeling of soft-body deformation. The term
$\mf{G}(\mf{q}, \mf{v})$ includes all other contributions that cannot guarantee
positive definiteness of their Jacobians, such as Coriolis and gyroscopic forces
arising in multibody dynamics with generalized coordinates.

Using the above definitions, we write our discrete update in the following form
\begin{align}
	\mf{m}(\mf{v}) &= \mf{J}(\mf{q}^{\theta_{q}})^T\mf{\bgamma},
	\label{eq:v_update}\\
	\mf{q} &= \mf{q}_0 + \delta t \dot{\mf{q}}^{\theta_{vq}} = \mf{q}_0 + \delta t\mf{N}(\mf{q}^{\theta_{q}})\mf{v}^{\theta_{vq}},
	\label{eq:q_update}
\end{align}
with the discrete momentum residual $\mf{m}(\mf{v})$ defined as
\begin{multline}
	\mf{m}(\mf{v}) =
	\mf{M}(\mf{q}^{\theta_{q}}(\mf{v}))(\mf{v}-\mf{v}_0) -
	\delta t\,\bar{\vf{\tau}}(\mf{q}^{\theta_{q}}(\mf{v}), \mf{v}^{\theta_v}(\mf{v})),
	\label{eq:m_definition}
\end{multline}
and the kinematic map $\mf{N}(\mf{q})$ as defined by Eq.
(\ref{eq:kinematic_map}). Notice that in the update for $\mf{q}$ we evaluate
$\mf{N}$ at $t^{\theta_{q}}$ and velocities at $t^{\theta_{vq}}$. This enables
our framework to generalize to some of the most popular schemes for forward
dynamics:
\begin{itemize}
	\item Explicit Euler with $\theta_q=\theta_{v}=\theta_{vq} = 0$,
	\item Symplectic Euler with $\theta_{q} = \theta_v = 0$ and $\theta_{vq}=1$,
	\item Implicit Euler with $\theta_{q} = \theta_v = \theta_{vq}= 1$, and
	\item Symplectic midpoint rule, which is second order, with $\theta_{q} =
	\theta_v = \theta_{vq}= 1/2$,
\end{itemize}

Similar to the work in \cite{bib:duriez2005realistic} for the simulation of
deformable objects and to projection methods used in fluid mechanics
\cite{bib::bell1991efficient}, we solve Eqs. (\ref{eq:v_update}) and
(\ref{eq:q_update}) in two stages. We first solve for the \emph{free motion
velocities} the system would have in the absence of contact constraints. We then
update the velocities so that they satisfy conservation of momentum along with
the contact constraints in the second stage. This two-stage approach is
advantageous in that it allows us to choose the most appropriate strategy at
each stage. For the update of free motion velocities, we use the
$\theta\text{-method}$ to attain the desired order of accuracy and energy
conservation properties, while for the second stage we use our primal
formulation of compliant contact presented in Section
\ref{sec:primal_formulation} to calculate the contact impulses.

In the first stage, we solve for the free motion velocities $\mf{v}^*$ in the
absence of constraint impulses, i.e.,
\begin{align}
	\mf{m}(\mf{v}^*) &= \mf{0}.
	\label{eq:vstar_definition}
\end{align}
For integration schemes that are implicit in $\mf{v}^*$ (e.g. the implicit Euler
scheme and the midpoint rule), we solve Eq. (\ref{eq:vstar_definition}) with
Newton's method. For schemes explicit in $\mf{v}^*$, only the mass matrix
$\mf{M}$ needs to be inverted, which can be accomplished efficiently using the
$\mathcal{O}(n)$ \emph{Articulated Body Algorithm}
\cite{bib:featherstone2008_rigid_body_dynamics_algorithms}.

In the second stage, we approximately solve Eq. (\ref{eq:v_update}) by
linearizing $\mf{m}(\mf{v})$ around $\mf{v}^*$. Our linearization uses a
symmetric positive definite (SPD) approximation $\mf{A}$ of the Jacobian
of $\mf{m}(\mf{v})$ with
\begin{align}
	\mf{A}&=\mf{M}+\delta t^2\,\theta_q\theta_{qv}\mf{K}+\delta t\,\theta_v\mf{D},
	\label{eq:expression_for_A}\\
	\mf{K}(\mf{q}, \mf{v})&=-\frac{\partial \mf{F}(\mf{q}, \mf{v})}{\partial
	\mf{q}}\frac{\partial\dot{\mf{q}}^{\theta_{vq}}}{\partial\mf{v}},
	\label{eq:stiffness_matrix}\\
	\mf{D}(\mf{q}, \mf{v})&=-\frac{\partial \mf{F}(\mf{q}, \mf{v})}{\partial
	\mf{v}},
	\label{eq:dissipation_matrix}
\end{align}
where $\mf{K} \succ 0$ and $\mf{D}\succ 0$ are the stiffness and damping matrices of the
system, respectively. As an example, for joint level spring-dampers models,
$\mf{K}$ and $\mf{D}$ are constant, diagonal, and positive definite matrices. A
more complex example arises in the Finite Element Model (FEM) of soft body
deformations. In this case, $\mf{K}$ and $\mf{D}$ are sparse positive definite
matrices.

As we will see in Section \ref{sec:primal_formulation}, this SPD approximation
allows us to write a convex formulation of contact satisfying an approximation
of the original momentum balance in Eq. (\ref{eq:v_update}),
\begin{align}
	\mf{A}(\mf{v}-\mf{v}^*) = \mf{J}^T\mf{\bgamma}.
	\label{eq:momentum_linearized}
\end{align}
Furthermore, the approximation in Eq. (\ref{eq:momentum_linearized}) and the
original discrete momentum update in Eq. (\ref{eq:v_update}) agree to second
order as shown by the following result, proved in Appendix
\ref{app:gradient_of_m_approximation}.
\begin{prop}	
Matrix $\mf{A}$ is a first order approximation to the Jacobian of $\mf{m}$,
i.e.,
\begin{align*}
	\left. \frac{\partial \mf{m}}{\partial \mf{v}} \right|_{\mf{v}=\mf{v}^*} = \mf{A} + \mathcal{O}(\delta t).
\end{align*}
Therefore, Eq. (\ref{eq:momentum_linearized}) is a second order approximation of
the discrete balance of momentum in Eq. (\ref{eq:v_update}). Moreover, $\mf{A}
\succ 0$.
\label{prop:gradient_of_m_approximation}
\end{prop}

We summarize our discrete time stepping strategy as follows
\begin{enumerate}
	\item Solve for the free motion velocities $\mf{v}^*$ in Eq.
	(\ref{eq:vstar_definition}).
	\item Compute the symmetric positive definite matrix $\mf{A}$ in Eq.
	(\ref{eq:expression_for_A}).
	\item\label{it:solve_for_contact} Solve for constraint impulses $\bgamma$
	that satisfy the linearized momentum Eq. (\ref{eq:momentum_linearized}) and
	the contact constraints. 
	\item Update the positions according to Eq. (\ref{eq:q_update}).
\end{enumerate}

The constraint impulses in step \ref{it:solve_for_contact} are the solutions to
our convex approximation of compliant contact described in the next section.

Notice that, in the absence of constraint impulses, the velocities at the next
time step are equal to the free motion velocities, i.e., $\mf{v}=\mf{v}^*$, and
they are computed with the order of accuracy of the $\theta\text{-method}$.
Furthermore, we also expect to recover the properties of the
$\theta\text{-method}$ when contact constraints are not active. As an example,
for bodies in contact that are under rolling friction,
the contact constraints behave as bi-lateral constraints that impose zero slip
velocity. In this case, our two stage method using the midpoint rule to compute
$\mf{v}^*$ exhibits considerably less numerical dissipation than other methods.
We demonstrate this in Section \ref{sec:spring_cylinder} with an example of a
mechanical system with rolling friction.

