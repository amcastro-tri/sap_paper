\section{Discrete Time Formulation}
\label{sec:discrete_time_formulation}

Our discrete-time model is based on the $\theta\text{-method}$ \cite[\S
II.7]{bib:hairer2008solving} and incorporates the symplectic midpoint rule to
attain second order accuracy and energy conservation. While most of the work in
the literature uses first order time-stepping schemes, the extension to the
second-order midpoint rule is analyzed in \cite{bib:potra2006linearly}. While
the work in \cite{bib:potra2006linearly} uses a polyhedral approximation of the
friction cone that leads to an LCP formulation, our approach does not
approximate the friction cone but introduces the convex approximation of contact
from \cite{bib:anitescu2006} \RedHighlight{TODO: Introduce definition of LCP in
the introduction}. We remark that combining the $\theta\text{-method}$ with the
convex approximation of contact is novel to our work. We write our discrete
update in the following form
\begin{eqnarray}
	\mf{M}(\mf{q}^{\theta_{q}})(\mf{v}-\mf{v}_0)  &=& \nonumber\\
	dt\,\mf{F}(\mf{q}^{\theta_{q}}, \mf{v}^{\theta_v}) &+&
	dt\,\mf{G}(\mf{q}^{\theta_{q}}, \mf{v}^{\theta_v}) +
	\mf{J}(\mf{q}^{\theta_{q}})^T\mf{\bgamma}, \label{eq:v_update}\\
	\mf{q} &=& \mf{q}_0 + dt\mf{N}(\mf{q}^{\theta_{q}})\mf{v}^{\theta_{vq}},
	\label{eq:q_update}
\end{eqnarray}
where $dt$ is the discrete fixed time step and $(\mf{q}_0, \mf{v}_0)$ denote
variables from the previous time-step. The \emph{mid-step quantities} $\mf{q}^{\theta_{q}}$, $\mf{v}^{\theta_{v}}$, and
$\mf{v}^{\theta_{vq}}$ are defined in accordance with the standard
$\theta\text{-method}$ using scalar parameters $\theta_q$ $\theta_v$ and
$\theta_{vq}$
\begin{eqnarray*}
	\mf{q}^{\theta_q} &=& \theta_q\mf{q} + (1-\theta_{q})\mf{q}_0,\\
	\mf{v}^{\theta_v} &=& \theta_v\mf{v} + (1-\theta_v)\mf{v}_0,\\
	\mf{v}^{\theta_{vq}} &=& \theta_{vq}\mf{v} + (1-\theta_{vq})\mf{v}_0.
\end{eqnarray*}

In particular, with Eq. (\ref{eq:q_update}) the mid-step configuration $\mf{q}^{\theta_q}$ can be written as
\begin{equation}
	\mf{q}^{\theta_q} = \mf{q}_0 + dt\theta_q\mf{N}(\mf{q}^{\theta_{q}})\mf{v}^{\theta_{vq}}
\end{equation}

We split forces into two contributions so that $\partial \mf{F}/\partial\mf{q}$ and $\partial \mf{F}/\partial\mf{v}$ are positive definite matrices while the same is generally not true for the gradients of $\mf{G}$. Therefore in $\mf{F}(\mf{q}, \mf{v})$ we will include modeling elements such as spring and dampers and even internal forces
for the modeling of soft-body deformation. $\mf{G}(\mf{q}, \mf{v})$ will include
all other contributions that cannot guarantee positive definiteness of the
gradients such as Coriolis and gyroscopic forces arising in multibody dynamics.

The discrete update in Eqs. (\ref{eq:q_update})-(\ref{eq:v_update}) generalizes
some of the most popular schemes for forward dynamics:
\begin{itemize}
	\item Explicit Euler with $\theta_q=\theta_{v}=\theta_{vq} = 0$,
	\item Symplectic Euler with $\theta_{q} = 0$ and $\theta_v = \theta_{vq}=1$,
	\item Implicit Euler with $\theta_{q} = \theta_v = \theta_{vq}= 1$,
	\item Symplectic midpoint rule, which is second order, with $\theta_{q} =
	\theta_v = \theta_{vq}= 1/2$,
\end{itemize}

Similar to the work in \cite{bib:duriez2005realistic} for the simulation of
deformable objects and to projection methods used in fluid mechanics
\cite{bib::bell1991efficient}, we solve Eqs. (\ref{eq:v_update}) and
(\ref{eq:q_update}) in two stages. We first define the momentum quantity
\RedHighlight{TODO: Figure out how to properly split this multiline equation}
\begin{eqnarray}
	\mf{m}(\mf{v}) &=&
	\mf{M}(\mf{q}^{\theta_{q}}(\mf{v}))(\mf{v}-\mf{v}_0) - \nonumber\\
	&&dt\,\mf{F}(\mf{q}^{\theta_{q}}(\mf{v}), \mf{v}^{\theta_v}(\mf{v}))-\nonumber\\
	&&dt\,\mf{G}(\mf{q}^{\theta_{q}}(\mf{v}), \mf{v}^{\theta_v}(\mf{v}))
	\label{eq:m_definition}
\end{eqnarray}

In the first stage we solve for the
\textit{free motion} velocities $\mf{v}^*$ in the absence of constraint impulses
\begin{eqnarray}
	\mf{m}(\mf{v}^*) &=& \mf{0},
	\label{eq:vstar_definition}\\
	\mf{q}^{\theta_q}(\mf{v}^*) &=& \mf{q}_0 + dt\theta_q\mf{N}(\mf{q}^{\theta_{q}})\mf{v}^{\theta_{vq}}(\mf{v}^*),
	\label{eq:qstar_definition}
\end{eqnarray}

For the implicit Euler scheme and the midpoint rule, Eqs.
(\ref{eq:vstar_definition})-(\ref{eq:qstar_definition}) are implicit in
$\mf{v}^*$ and we solve them using Newton's method. The explicit and symplectic
Euler schemes require inversion of the mass matrix $\mf{M}$, which can be
accomplished efficiently using the $\mathcal{O}(n)$
\emph{Articulated Body Algorithm}
\cite{bib:featherstone2008_rigid_body_dynamics_algorithms}.

For the second stage we linearize $\mf{m}(\mf{v})$ around $\mf{v} = \mf{v}^*$ 
\begin{eqnarray}
	\mf{m}(\mf{v}) = \mf{m}(\mf{v}^*) +
	\frac{\partial\mf{m}}{\partial\mf{v}}\Bigr|_{\mf{v}^*}(\mf{v}-\mf{v}^*) + \mathcal{O}_m(\Vert\mf{v}-\mf{v}^*\Vert^2)
\end{eqnarray}
and take the gradient of $\mf{m}(\mf{v})$ in Eq. (\ref{eq:m_definition})
and write it as
\begin{eqnarray}
	\frac{\partial\mf{m}}{\partial\mf{v}}\Bigr|_{\mf{v}^*} = 
	\mf{M}^* + \mf{E}^* -
	dt\frac{\partial\mf{F}}{\partial\mf{v}}^* -
	dt\frac{\partial\mf{G}}{\partial\mf{v}}^*
\end{eqnarray}
where the superscript $^*$ denotes quantities evaluated at $\mf{v}^*$ and matrix $\mf{E}$ contains the gradients of $\mf{M}$, with elements
\begin{eqnarray}
	E_{ij} &= &
	(v_k-v_{0,k}) 
	\frac{\partial M_{ik}(\mf{q}^{\theta_q})}{\partial v_j}\nonumber\\
	&=&dt\,(v_k-v_{0,k}) 
	\frac{\partial M_{ik}(\mf{q}^{\theta_q})}{\partial
	q_m}\frac{\partial\dot{q}_m}{\partial v_j}
\end{eqnarray}

We expand the gradients of $\mf{F}(\mf{v})=\mf{F}(\mf{q}^{\theta_{q}}(\mf{v}), \mf{v}^{\theta_v}(\mf{v}))$ as
\begin{eqnarray}
	\frac{\partial\mf{F}(\mf{v})}{\partial\mf{v}} =
	-dt\,\theta_q\theta_{qv}\mf{K}(\mf{q}^{\theta_q}, \mf{v}^{\theta_v})-\theta_v\mf{D}(\mf{q}^{\theta_q}, \mf{v}^{\theta_v})
\end{eqnarray}
with 
\begin{eqnarray}
	\mf{K}(\mf{q}, \mf{v})&=&-\frac{\partial \mf{F}(\mf{q}, \mf{v})}{\partial \mf{q}}\mf{N}(\mf{q}),\\
	\mf{D}(\mf{q}, \mf{v})&=&-\frac{\partial \mf{F}(\mf{q}, \mf{v})}{\partial \mf{v}}.
	\label{eq:dissipation_matrix}
\end{eqnarray}

We now replace our expansion of $\mf(\mf{v})$ to 
obtain an approximation of Eq. (\ref{eq:v_update})
\begin{eqnarray}
	\mf{A}(\mf{v}-\mf{v}^*)= \mf{J}^T\mf{\gamma}
	\label{eq:momentum_linearized}
\end{eqnarray}
with
\begin{eqnarray}
	\mf{A}&=&\mf{M}+\theta_q\theta_{qv} dt^2\,\mf{K}+\theta_v dt\,\mf{D},
	\label{eq:expression_for_A}\\
	\mf{K}&=&-\frac{\partial \mf{F}}{\partial \mf{q}}\Bigr|_{(\mf{q}^{\theta_q}, \mf{v}^{\theta_v})},\\
	\mf{D}&=&-\frac{\partial \mf{F}}{\partial \mf{v}}\Bigr|_{(\mf{q}^{\theta_q},
	\mf{v}^{\theta_v})}.
	\label{eq:dissipation_matrix}
\end{eqnarray}
where the only assumption in Eq. (\ref{eq:expression_for_A}) is that the map
$\mf{N}(\mf{q})$ is the identity \GreenHighlight{Recommend never introducing N
if it is always the identity} which is commonly the case for degrees of freedom
used to model compliant elements. When $\mf{F}(\mf{q}, \mf{v})$ is linear the
stiffness matrix $\mf{K}$ and the damping matrix $\mf{D}$ are constant and the
two stage process described by Eqs. (\ref{eq:vstar_definition}) to
(\ref{eq:momentum_linearized}) is exact and solves the original problem stated
by Eq. (\ref{eq:v_update}).




A typical example of constant stiffness and damping is that of a spring-damper
model at a joint. In this case these matrices only contribute positive diagonal
elements to matrix $\mf{A}$.

An example of complex stiffness and damping matrices is when using a Finite
Element Model (FEM) of large soft body deformations. In this case $\mf{K}$ and
$\mf{D}$ are large sparse, positive definite, matrices.

Notice that, in the
absence of constraint impulses, the next step velocity is $\mf{v}=\mf{v}^*$ and
it is computed with the order of accuracy of the $\theta\text{-method}$. 



We also
expect to recover the order of accuracy of the $\theta\text{-method}$ when
constraints do not produce work. For instance, for a rolling wheel the stiction
constraint does not dissipate energy since the slip velocity is zero even though
the friction force is non-zero, i.e. $\bgamma_t\cdot\mf{v}_t = 0$. Moreover, we
will see in Section XXX that the symplectic midpoint rule conserves energy
exactly during rolling.\RedHighlight{Alejandro: Add proper reference to the
billiard balls example in the numerical examples section.}

Our convex approximation of contact requires $\mf{A}\succ 0$. Therefore only
compliant and dissipation elements that lead to positive definite matrices can
be included in Eq. (\ref{eq:expression_for_A}). This is the case for joint
spring-damper models and deformable models. It is not the case for Coriolis and
gyroscopic terms. These terms can still be treated implicitly in Eqs.
(\ref{eq:vstar_definition}) and (\ref{eq:qstar_definition}), but their
derivative is assumed to be zero in Eq. (\ref{eq:dissipation_matrix}), an
approximation only accurate to first order. \GreenHighlight{What does "treated
implicitly" mean? In what way is their derivative is zero in
\ref{eq:dissipation_matrix}? When you introduced $F(q,v)$ you said that it
already includes gyroscopic and Corolis terms, but this discussion seems to
about how to add them, as if they weren't already there...  }

