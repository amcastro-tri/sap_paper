% Dummy comment for Reviewable.

\subsection{Analytical Inverse Dynamics}
\label{sec:analytical_inverse_dynamics}

Remarkably,  the dual optimal impulses of~\eqref{eq:dual_regularized} can be
constructed from the primal optimal velocities of~\eqref{eq:primal_regularized}
using a simple projection operation. Following~\cite{bib:todorov2014}, we call
this construction  \textit{inverse dynamics}. Moreover, this projection
decomposes into a set of individual projections for each contact impulse
$\bgamma_i$ given the separable structure of the constraints. Letting
$\vf{y}_i(\vf{v}_{c,i}) = -\vf{R}_i^{-1}(\vf{v}_{c,i}-\hat{\vf{v}}_{c,i})$,
these projections take the form
\begin{equation}
  \begin{aligned}
	\bgamma_i(\vf{v}_{c,i})&= P_{\mathcal{F}_i}(\vf{y}_i(\vf{v}_{c,i}))\\
	&= \argmin_{\bgamma\in\mathcal{F}_i} \quad 
		\frac{1}{2}(\bgamma-\vf{y}_i)^T\vf{R}_i(\bgamma-\vf{y}_i),\\
	\end{aligned}
	\label{eq:y_projection}
\end{equation}
where $\vf{R}_i\in\mathbb{R}^{3\times3}$ is the $i\text{-th}$ diagonal block of
the regularization matrix $\mf{R}$. That is, $\bgamma_i$ is the projection
$P_{\mathcal{F}_i}$ of $\vf{y}_i(\vf{v}_{c,i})$ onto the friction cone
$\mathcal{F}_i$ using the norm defined by $\vf{R}_i$. The projection
$P_{\mathcal{F}}(\mf{y})$ onto the full cone $\mathcal{F} := \mathcal{F}_1
\times \mathcal{F}_2 \times \cdots \times \mathcal{F}_{n_c}$ is obtained by simply
stacking together the individual projections $P_{\mathcal{F}_i}(\vf{y}_i)$ from
Eq. (\ref{eq:y_projection}), where we form $\mf{y}$ by stacking together each
$\vf{y}_i$ from all contact pairs.  In this notation, the optimal impulse
$\bgamma$ of~\eqref{eq:dual_regularized} and the optimal velocities $\mf{v}$
of~\eqref{eq:primal_regularized} satisfy  $\bgamma =
P_{\mathcal{F}}(\mf{y}(\mf{v}))$.

\subsection{Compliant Contact, Principle of Maximum Dissipation and Artifacts}
\label{sec:physical_intuition}

Thus far, $\vf{R}_i$ and $\hat{\vf{v}}_{c,i}$ have been treated as known problem
data. This section makes an explicit connection of these quantities with
physical parameters to model compliant contact with regularized friction. Notice
this approach is different from the one in \cite{bib:todorov2014}, where
regularization is not used to model physical compliance but rather to introduce
a user tunable Baumgarte-style stabilization to avoid constraint drift. We want
to model compliant contact as in Eq. (\ref{eq:compliant_model}) with stiffness
$k$ (in N/m) and linear dissipation $d = \tau_d k$ where $\tau_d$ (in seconds)
is the \textit{dissipation time scale}. 

Dropping subscript $i$ for simplicity, we solve the projection problem in Eq.
(\ref{eq:y_projection}) analytically in Appendix
\ref{app:analytical_inverse_dynamics_derivations} for a regularization matrix of
the form $\vf{R} = \text{diag}([R_t, R_t, R_n])$
\begin{eqnarray}
	\bgamma &=& P_\mathcal{F}(\vf{y}) \label{eq:analytical_y_projection}\\
    &=&\begin{dcases}
	% Region I, stiction
	\vf{y} 
	% When we  have:
	& \text{stiction, } y_r \le \mu y_n\\
	%
	%
	% Region II, sliding.
	\begin{bmatrix}
		\mu\gamma_n\hat{\vf{t}}\\
		\frac{1}{1+\tilde\mu^2}\left(y_n + \hat\mu y_r\right)
	\end{bmatrix}
	% When we  have:
	& \text{sliding, } -\hat\mu y_r < y_n \leq \frac{y_r}{\mu}\\
	%
	%
	% Region III, no contact.
    \vf{0} & \text{no contact, } y_n < -\hat\mu y_r \end{dcases}\nonumber	
\end{eqnarray}
where $\vf{y}_t$ and $y_n$ are the tangential and normal components of $\vf{y}$,
$y_r=\Vert\vf{y}_t\Vert$ is the radial component, and
$\hat{\vf{t}}=\vf{y}_t/y_r$ is the unit tangent vector. We also define the
coefficients $\tilde\mu=\mu\,(R_t/R_n)^{1/2}$ and $\hat\mu=\mu\,R_t/R_n$ that
result from the \textit{warping} introduced by the metric $\vf{R}$.

Our compliant model of contact is defined by
\begin{eqnarray*}
	\hat{\vf{v}}_c &=&
	\begin{bmatrix}
		0\\
		0\\
		\hat{v}_n \end{bmatrix}\nonumber,\\
	\hat{v}_n &=& -\frac{\phi_0}{\delta t+\tau_d},
\end{eqnarray*}
where $\phi_0$ is the previous step signed distance. The normal direction
regularization parameters is taken as $R_n^{-1} = \delta t k(\delta t+\tau_d)$.
To gain physical insight into our model, we substitute
$\vf{y}=-\vf{R}^{-1}(\vf{v}_c - \hat{\vf{v}}_c)$ into Eq.
(\ref{eq:analytical_y_projection}) to obtain
\begin{align*}
	&\bgamma(\vf{v}_c) = P_\mathcal{F}(\vf{y}(\vf{v}_c))\\
&=\begin{dcases}
	% Region I, stiction
	\begin{bmatrix}
		-\vf{v}_t/R_t\\
		-\delta t(k\,\phi + d\,v_n)
	\end{bmatrix}
	% When we  have: y_r < \mu y_n
	& \text{stiction, } \\
	%
	%
	% Region II, sliding.
	\begin{bmatrix}
		\mu\gamma_n\hat{\vf{t}}\\
		-\frac{\delta t}{1+\tilde\mu^2}\left(k(\phi-(\delta
		t+\tau_d)\mu\Vert\vf{v}_t\Vert) + d\,v_n \right)
	\end{bmatrix}
	% When we  have:  -\mu \frac{R_t}{R_n} y_r < y_n \leq \frac{y_r}{\mu}
	& \text{sliding, }\\
	%
	%
	% Region III, no contact.  y_n \leq -\mu \frac{R_t}{R_n} y_r
    \vf{0} & \text{no contact, } \end{dcases}\nonumber	
\end{align*}
where $\phi= \phi_0 + \delta t\,v_n$ approximates the signed distance function
at the next time step. Let us now analyze the resulting forces from this model.

\textbf{Friction Forces}. We see that friction forces behave exactly as a model
of regularized friction
\begin{equation*}
	\bgamma_t = \min\left(\frac{\Vert\vf{v}_t\Vert}{R_t}, \mu\gamma_n\right)\hat{\vf{t}},
\end{equation*}
with $\bgamma_t$ linear with the (very small) slip velocity during stiction and
with a maximum value given by $\mu\gamma_n$, effectively modeling Coulomb's
friction. Notice that to better model stiction, we are interested in small
values of $R_t$. We discuss our parameterization of $R_t$ in Section
\ref{sec:understanding_model_parameters}. Moreover, since $\hat{\vf{t}} =
\vf{y}_t/\Vert\vf{y}_t\Vert = -\vf{v}_t/\Vert\vf{v}_t\Vert$, friction forces
oppose sliding and therefore satisfy the principle of maximum dissipation.

\textbf{Normal Forces}. We observe that in stiction, we recover the compliant
model given by Eq. (\ref{eq:compliant_model}), as desired. In the sliding
region, however, we see that the convex approximation introduces unphysical
artifacts. 

Firstly, the factor $1+\tilde{\mu}^2$ models an effective stiffness
$k_\text{eff}=k/(1+\tilde{\mu}^2)$ and dissipation
$d_\text{eff}=d/(1+\tilde{\mu}^2)$, different from the physical values. This
tell us that in order to accurately model compliance during sliding we must
satisfy the condition $\tilde\mu=\mu\,(R_t/R_n)^{1/2} \approx 0$ or,
equivalently, $R_t \ll R_n$. Section \ref{sec:understanding_model_parameters}
introduces a parameterization of $R_t$ that satisfies this condition.

Secondly, while we'd like to recover $\gamma_n = -\delta t(k\,\phi + d\,v_n)$ as
in stiction, we instead see that the slip velocity $\vf{v}_t$ unphysically
couples into the normal forces as $\gamma_n=-\delta t(k(\phi-(\delta
t+\tau_d)\mu\Vert\vf{v}_t\Vert) + d\,v_n)$. We can write this as
\begin{equation*}
  \gamma_n/\delta t=-(k\,\phi_\text{eff} + d\,v_n),
\end{equation*}
with an \textit{effective} signed distance $\phi_\text{eff} = \phi-(\delta
t+\tau_d)\mu\Vert\vf{v}_t\Vert$. That is, we recover the dynamics of compliant
contact but with a spurious drift of magnitude $(\delta
t+\tau_d)\mu\Vert\vf{v}_t\Vert$.

This is consistent with the formulation in \cite{bib:anitescu2010} for rigid
contact when $k\rightarrow \infty$ and $\tau_d=0$, leading to an unphysical
\textit{gliding effect} at a positive distance $\phi=\delta
t\mu\Vert\vf{v}_t\Vert$. Notice that the \textit{gliding} goes away as $\delta
t\rightarrow 0$ since the formulation converges to the original contact problem
\cite{bib:anitescu2006}. The effect of compliance is to \textit{soften} this
gliding effect. 

With finite compliance,  the normal force when sliding goes to
$-k(\phi-\tau_d\mu\Vert\vf{v}_t\Vert)$ in the limit to $\delta t\rightarrow 0$.
This tells us that, unlike the rigid case, the \textit{gliding} effect
unfortunately does not go away as $\delta t\rightarrow 0$. It persists with a
finite value that now depends on the dissipation rate,
$\phi\approx\tau_d\mu\Vert\vf{v}_t\Vert$.

We close this discussion by making the following remarks relevant to robotics
applications:
\begin{enumerate}
	\item We are mostly interested in the stiction regime, typically for
	grasping, locomotion, or rolling contact for mobile bases with wheels. This
	regime is precisely where the convex approximation does not introduce
	artifacts.
	\item Sliding usually happens with low velocities and therefore the term
	$\delta t\mu\Vert\vf{v}_t\Vert$ is negligible.
	\item For robotics applications, we are mostly interested in inelastic
	contact. We will see that this can be effectively modeled with
	$\tau_d\approx\delta t$ in Section \ref{sec:understanding_model_parameters}.
	Therefore, in this regime, the term $\tau_d\mu\Vert\vf{v}_t\Vert$ also goes
	to zero as $\delta t\rightarrow 0$.
	\item We are definitely interested in the onset of sliding. This is captured
	by the approximation which properly models the Colulomb friction law.
\end{enumerate}
