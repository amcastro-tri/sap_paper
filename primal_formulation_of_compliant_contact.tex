
\section{A Primal Formulation of Compliant Contact}
In this section we give a quadratic program with second order cone constraints
that augments the balance of momentum stated in Eq.
(\ref{eq:momentum_linearized}) to model compliant contact with Coulomb friction.
We call this optimization problem our \emph{primal formulation}, as we will see
that it's dual is precisely the formulation in Eq. (\ref{eq:dual_regularized}).

We write our primal formulation of compliant contact by introducing a new
decision variable $\vf{\sigma}\in\mathbb{R}^{3n_c}$ as
\begin{equation}
	\begin{aligned}
	\min_{\mf{v},\bsigma} \quad & \ell_p(\mf{v},\bsigma) = 
	\frac{1}{2}\Vert\mf{v}-\mf{v}^*\Vert_A^2 + \frac{1}{2} \Vert\bsigma\Vert_{R}^2\\
	\textrm{s.t.} \quad & \mf{g} = (\mf{J}\mf{v}-\hat{\mf{v}} + \mf{R}\bsigma) \in \mathcal{F}^*\\
	\end{aligned}
	\label{eq:primal_regularized}
\end{equation}
where $\mathcal{F^*}= \mathcal{F}^*_1 \times \mathcal{F}^*_2 \times \cdots
\times \mathcal{F}^*_{n_k}$ is the \emph{dual cone} of the convex cone
$\mathcal{F}$. The positive diagonal matrix $\mf{R}\in\mathbb{R}^{3n_c\times
3n_c}$ and the vector of stabilization velocities $\hat{\mf{v}}$ encode the
problem data needed to model compliant contact. We will establish a clear
physical meaning for these terms when we provide analytical expressions for the
impulses in Section \ref{sec:analytical_inverse_dynamics}. Finally,
$\Vert\mf{z}\Vert_X^2=\mf{z}^T\mf{X}\mf{z}$ for $\mf{X}\succ 0$.

\begin{theorem}
The dual of Eq. (\ref{eq:primal_regularized}) is given by Eq.
(\ref{eq:dual_regularized}). The pair $\{\mf{v},\bsigma\}$ is primal optimal and
$\bgamma$ is dual optimal. Moreover, $\bsigma = \bgamma$.
\end{theorem}

\begin{proof}
The Lagrangian of the primal formulation in Eq. (\ref{eq:primal_regularized}) is
\begin{equation}
	\mathcal{L}(\mf{v},\bsigma,\vf{\gamma}) = 
	\frac{1}{2}\Vert\mf{v}-\mf{v}^*\Vert_A^2 + \frac{1}{2} \Vert\bsigma\Vert_{R}^2 - \vf{\gamma}^T\mf{g}
	\label{eq:primal_lagrangian}
\end{equation}
with $\vf{\gamma}\in\mathcal{F}$ the dual variable to enforce the constraint
$\vf{g}\in \mathcal{F}^*$. We obtain the dual of Eq.
(\ref{eq:primal_regularized}) by minimizing the Lagrangian jointly in the
variables $\mf{v}$ and $\bsigma$ and replacing the result back to obtain the
dual cost $\ell_d(\vf{\gamma})$. Minimizing jointly in the variables $\mf{v}$
and $\bsigma$ leads to the conditions
\begin{eqnarray}
	\mf{A}(\mf{v}-\mf{v}^*) &=& \mf{J}^T\vf{\gamma}\\
	\vf{\sigma} &=& \vf{\gamma}
\end{eqnarray}
where with the first equation we find out that multipliers $\bgamma$ are indeed
impulses and we recover the balance of momentum, and the second equation allows
us to eliminate $\vf{\sigma}$. When we replace these results back into the
Lagrangian in Eq. (\ref{eq:primal_lagrangian}) we obtain the dual
\begin{eqnarray}
	\min_{\bgamma\in \mathcal{F}} \ell_d(\bgamma) =
	\frac{1}{2}\bgamma^T(\mathbf{W}+\mathbf{R})\bgamma + {\bm r}^T
	\bgamma
\end{eqnarray}
where, in contrast to previous work, our Delassus operator
$\mf{W}=\mf{J}\mf{A}\mf{J}^T$ now also contains the contribution of internal
force elements (through Eq. (\ref{eq:expression_for_A})) and
$\mf{r}=\mf{v}_c^*-\hat{\mf{v}}$ with $\mf{v}_c^*=\mf{J}\mf{v}^*$.
\end{proof}

While in practical problems contact forces are underdetermined, adding
regularization guarantees a unique solution. Moreover we show in Section
\ref{sec:physical_intuition} how this regularization can be used to introduce a
physical model of compliant contact. In the limit to rigid contact, when
regularization $\mf{R}$ is zero, our primal formulation reduces to that
presented in \cite{bib:mazhar2014}.

A drawback of introducing regularization is that the small values of
regularization needed to accurately model stiff contact with Coulomb friction
lead to ill conditioning of the Hessian. Therefore, even though the problem is
well posed mathematically, off-the-shelf solvers we tried do not perform well in
practice. In Sections \ref{sec:unconstrained_convex_formulation} and
\ref{sec:sap_solver} we describe a methodology to solve our formulation that is
robust, warm-starts effectively and performs well solving problems of practical
interest.
