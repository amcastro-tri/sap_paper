
\section{A Primal Formulation of Compliant Contact}

In this section we augment the balance of momentum stated in Eq.
(\ref{eq:momentum_linearized}) so that contact impulses model Colulomb friction
and satisfy the principle of maximum dissipation when sliding. 

An alternative is to use the convex approximation as stated in Eq.
(\ref{eq:dual_cost}). However, this formulation is severely ill conditioned due
to the fact that contact forces for rigid body dynamics problems are most often
underdetermined. Even if compliance is added in the normal direction, friction
forces for the simplest problem configurations will be underdetermined.
Regularization in Eq. (\ref{eq:dual_regularized}) helps to solve this problem in
theory but it leads to very ill conditioned systems of equations in practice. 
\CyanHighlight{Xuchen: Is there a reference?}

We make the following observation for the convex approximation in Eq.
(\ref{eq:dual_cost}): even if the set of contact forces is not unique (when no
regularization is added), velocities are. This fact inspired the search
for an equivalent formulation but in velocities instead of impulses. Such a
\textit{primal} formulation is presented in \cite{bib:mazhar2014} for rigid
contact, though to the knowledge of the authors a practical solver based on this
formulation has never been presented.

In this section we extend the formulation in \cite{bib:mazhar2014} to include
the modeling of compliance and in Sections
\ref{sec:unconstrained_convex_formulation} and \ref{sec:solver_details} we
describe a methodology to solve it in practice.

We write our primal formulation of compliant contact by introducing a new
decision variable $\vf{\sigma}\in\mathbb{R}^{3n_c}$ as
\begin{equation}
	\begin{aligned}
	\min_{\mf{v},\bsigma} \quad & \ell_p(\mf{v},\bsigma) =
	\frac{1}{2}\Vert\mf{v}-\mf{v}^*\Vert_{A}^2 +
	\frac{1}{2} \Vert\bsigma\Vert_{R}^2\\
	\textrm{s.t.} \quad & \mf{g} = (\mf{J}\mf{v}-\hat{\mf{v}} + \mf{R}\bsigma) \in \mathcal{F}^*\\
	\end{aligned}
	\label{eq:primal_regularized}
\end{equation}
where $\Vert\mf{z}\Vert_X^2=\mf{z}^T\mf{X}\mf{z}$ with $\mf{X}\succ 0$
and $\mathcal{F^*}=\prod_{k=1}^{n_k}\mathcal{F}^*_k$ is the dual of the convex
set $\mathcal{F}$. The positive diagonal matrix $\mf{R}\in\mathbb{R}^{3n_c\times
3n_c}$ and the vector of stabilization velocities $\hat{\mf{v}}$ encode the
problem data needed to model compliant contact. We will establish a very clear
physical meaning for these terms when we provide analytical expressions for the
impulses in Section \ref{sec:analytical_inverse_dynamics}.

\begin{theorem}	
The dual of Eq. (\ref{eq:primal_regularized}) is given by Eq.
(\ref{eq:dual_regularized}). The pair $\{\mf{v},\bsigma\}$ is primal optimal and
$\bgamma$ is dual optimal. Moreover, $\bsigma = \bgamma$.
\label{th:primal_dual_equivalence}
\end{theorem}

\begin{IEEEproof}
The Lagrangian of the primal formulation in Eq. (\ref{eq:primal_regularized}) is
\begin{equation}
	\mathcal{L}(\mf{v},\bsigma,\vf{\gamma}) =
	\frac{1}{2}\Vert\mf{v}-\mf{v}^*\Vert_{A}^2 +
	\frac{1}{2} \Vert\bsigma\Vert_{R}^2 - \vf{\gamma}^T\mf{g}
	\label{eq:primal_lagrangian}
\end{equation}
with $\vf{\gamma}\in\mathcal{F}$ the dual variable to enforce the constraint
$\vf{g}\in \mathcal{F}^*$. We obtain the dual of Eq.
(\ref{eq:primal_regularized}) by minimizing the Lagrangian jointly in the
variables $\mf{v}$ and $\bsigma$ and replacing the result back to obtain the
dual cost $\ell_d(\vf{\gamma})$. Minimizing jointly in the variables $\mf{v}$
and $\bsigma$ leads to the conditions
\begin{eqnarray}
	\mf{A}(\mf{v}-\mf{v}^*) &=& \mf{J}^T\vf{\gamma}\\
	\vf{\sigma} &=& \vf{\gamma}
\end{eqnarray}
where with the first equation we find out that multipliers $\bgamma$ are indeed
impulses and we recover the balance of momentum, and the second equation allows
us to eliminate $\vf{\sigma}$. When we replace these results back into the
Lagrangian in Eq. (\ref{eq:primal_lagrangian}) we obtain the dual
\begin{eqnarray}
	\min_{\bgamma\in \mathcal{F}} \ell_d(\bgamma) =
	\frac{1}{2}\bgamma^T(\mathbf{W}+\mathbf{R})\bgamma + {\bm r}^T
	\bgamma
\end{eqnarray}
where, in contrast to previous work, our Delassus operator
$\mf{W}=\mf{J}\mf{A}\mf{J}^T$ now also contains the contribution of internal
force elements (through Eq. (\ref{eq:expression_for_A})) and
$\mf{r}=\mf{v}_c^*-\hat{\mf{v}}$ with $\mf{v}_c^*=\mf{J}\mf{v}^*$.
\CyanHighlight{Xuchen: It should be $\mf{W}=\mf{J}\mf{A}^{-1}\mf{J}^T$.
Also, the derivation here is not completely trivial. Perhaps we should include
the detail in supplementary technical document/Appendix?}
\end{IEEEproof}

In Section \ref{sec:geodesic_solver}, we present a custom implementation of the
geodesic solver developed in \cite{bib:permenter2020} designed to exploit the
structure of our primal formulation in Eq. (\ref{eq:primal_regularized}).
