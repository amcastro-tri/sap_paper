\section{Constraints Based Modeling Framework}
\label{sec:constraints_based_modeling_framework}

This extends the work in \cite{bib:todorov2014} by using regularization to model
true physical compliance instead of a means to introduce a Baumgarte-style
stabilization. As a result, we not only obtain a model that enables the modeling
of true compliant elements, but we gain a very simple to understand insight on
the unphysical artifacts introduced by the convex approximation of contact.

We consider holonomic constraints $\mf{p}(\mf{q};t)=\mf{0}$ as well as
non-holonomic constraints $\mf{u}(\mf{v}; \mf{q},t)=\mf{J}_u\,\mf{v}+\mf{b}_u=
\mf{0}$. We treat both sets of constraints at the velocity level to write
\begin{equation}
	\mf{v}_c = \mf{J}\mf{v}+\mf{b}=\mf{0}
	\label{eq:velocity_level_constraints}
\end{equation}
where $\mf{v}_c$ is the constraints velocity, $\mf{J}$ the constraints Jacobian
and $\mf{b}$ is a velocity bias.

In our compliant formulation of constraints we relax Eq.
(\ref{eq:velocity_level_constraints}) so that when impulses $\bgamma$ are in the
interior of $\mathcal{C}$, they behave as the linear spring and damper law
\begin{equation}
	\bgamma = -dt(\mf{k}\,\mf{p} + \mf{c}\,\mf{v}_c)
	\label{eq:compliant_constraints}
\end{equation}
where stiffness $\mf{k}$ and damping $\mf{c}$ matrices are diagonal. For
Non-holonomic constraints stiffness is zero and damping \textit{regularizes} the
problem.

In the discrete time setting we again use the $\theta\text{-method}$ with
parameter $\theta_c$, different from $\theta$ in Eq.
(\ref{eq:v_update}) to gain more control on the stability and
accuracy of the method. E.g.: we typically use $\theta_c=1$ for contact
constraints for additional stability while we use $\theta_c=1/2$ for holonomic
constraints for better energy conservation. Using $\mf{v}_c^{\theta_c}$ and
$\mf{p}^{\theta_c}=\mf{p}_0+dt\mf{v}_c^{\theta_c}$ in Eq.
(\ref{eq:compliant_constraints}) and grouping terms we can write

\begin{eqnarray}
	\gamma_i &=& -R_i^{-1}(v_{c,i}-\hat{v}_i)\nonumber\\
	R_i^{-1} &=& \theta_c dt (dt\,k_i+c_i)\nonumber\\
	\hat{v}_i &=& -\frac{k_i}{\theta_c(dt\,k_i+c_i)}p_{0,i}-
	              \frac{1-\theta_c}{\theta_c}v_{c0,i}
\end{eqnarray}
\todo{contrast this to Torodorv's stabilization and show how his is unstable.}

We can then define the regularization matrix $\mf{R}=\text{diag}(\{R_i\})$ and
fit the compliant laws within the framework developed in \cite{bib:todorov2014}
\begin{eqnarray}
	\mf{y} &=& -\vf{R}^{-1}(\mf{v}_c-\hat{\mf{v}}) \label{eq:y_definition}\\
	\bgamma &=& P_\mathcal{C}(\mf{y})
	\label{eq:projection_definition}
\end{eqnarray}
where $P_\mathcal{C}(\mf{y})$ is the projection onto $\mathcal{C}$ of $\mf{y}$
using the norm defined by $\vf{R}$. That is
\begin{equation}
	\begin{aligned}
		P_\mathcal{C}(\mf{y})=\argmin_{\bgamma\in\mathcal{C}} \quad & \frac{1}{2}(\bgamma-\mf{y})^T\mf{R}(\bgamma-\mf{y})
	\end{aligned}
\end{equation}

That is, while the impulse is strictly inside the convex set $\mathcal{C}$, Eq.
(\ref{eq:y_definition}) essentially enforces a penalty on the constraint
violation untilt $\mf{y}$ comes out of $\mathcal{C}$ and then Eq.
(\ref{eq:projection_definition}) projects it back to its boundary.

Before jumping into the details provided in Section
\ref{app:analytical_inverse_dynamics_derivations} here we'll summarize how, with
the proper definition of the velocity bias $\hat{\mf{v}}$, convex set
$\mathcal{C}$ and regularization $\mf{R}$, we can model a variety of physical
effects such as
\begin{itemize}
	\item Joint limits.
	\item Joint dry friction.
	\item PD control with force limits.
	\item Frictional contact.
\end{itemize}
\todo{continue propagating $\theta_c$ to the rest of the constraints.}

\subsection{Joint Limits}

Given a one-dof joint modeled with (scalar) minimal coordinates $q$ and $v$, we
can model the limit $q_l < q < q_u $ using two constraints (one for each, lower
and upper). In this case we have
\begin{eqnarray}
	\mf{g} &=&
	% J*v
	\begin{bmatrix}
		v\\
		v\\
	\end{bmatrix} -
	% vhat
	\begin{bmatrix}
		\hat{v}_l\\
		\hat{v}_u\\
	\end{bmatrix}\\
	\mf{R} &=& R\,\mf{I}_2
\end{eqnarray}
with
\begin{eqnarray}
	\hat{v}_l&=&-\frac{q_0-q_l}{\theta_c(dt+\tau)}-\frac{1-\theta_c}{\theta_c}v_0\\
	\hat{v}_u&=&-\frac{q_0-q_u}{\theta_c(dt+\tau)}-\frac{1-\theta_c}{\theta_c}v_0\\
	R^{-1}&=&\theta_c dt^2 k(1+\tau/dt)
\end{eqnarray}
where the dissipation rate $\tau$ is defined such that $c=\tau\,k$. The convex
set is $\mathcal{C}=\mathbb{R}^+$ with the projection
\begin{eqnarray}
	\gamma = y^+= \max(0, y)
\end{eqnarray}


\subsection{Joint Dry Friction}

In this case we'd like the joint impulse to be limited within an interval
$\mathcal{C} = [-dt\tau_M, dt\tau_M]$, where $\tau_M$ is a specified load.
Within that interval, given our regularized model, we'd like the joint force to
penalize motion. We can achieve this with
\begin{equation}
	y = -dt\frac{\tau_M}{v_s}v
\end{equation}

where $v_s$ is a \textit{stiction tolerance} with units of m/s for prismatic
joints and with units of rad/s for revolute joints. Therefore we have
\begin{eqnarray}
	\hat{v} &=& 0\nonumber\\
	R^{-1} &=& dt\frac{\tau_M}{v_s}
\end{eqnarray}

\subsection{PD Control with Force Limits}
In this case stiffness and dissipation are replaced by proportional and
derivative PD gains, respectively. To make the analogy with a spring-mass model
closer, the proportional gain is written as $k_p = k$ and the derivative gain as
$k_d = c = \tau k_p$. For this case $\mathcal{C} = [\gamma_l, \gamma_u] =
[dt\,u_l, dt\,u_u]$, where $u_l < u_u$ are lower and upper actuation limits.  In
this case, when inside the set $\mathcal{C}$, we want the impulse to be
\begin{eqnarray}
	y/dt = -k_p(q-q_d)-k_d(v-v_d)
\end{eqnarray}
where $q_d$ and $v_d$ are desired position and velocity respectively. We can
accomplish this with
\begin{eqnarray}
	\hat{v} &=& -\frac{q_0-q_d}{dt+\tau}+\frac{\tau}{dt}v_d\nonumber\\
	R^{-1}  &=& dt^2k(1+\tau/dt)
\end{eqnarray}

The convex set is $\mathcal{C} = [dt\,u_l, dt\,u_u]$ with projection
\begin{equation}
	\gamma = \min(\gamma_u, \max(\gamma_l, y))
\end{equation}


\subsection{Frictional Contact}
In this case we have
\begin{equation}
	\vf{g} = \vf{v}_c - \hat{\vf{v}}_c = \mf{J_c}\mf{v} - \hat{\vf{v}}_c
\end{equation}
where $\mf{J}_c$ is the contact Jacobian and 
\begin{eqnarray}
	\hat{\vf{v}}_c &=&
	\begin{bmatrix}
		0\\
		0\\
		\hat{v}_n \end{bmatrix}\nonumber\\
	\hat{v}_n &=& -\frac{\phi_0}{dt+\tau}\nonumber\\
	\mf{R} &=& \text{diag}([R_t, R_t, R_n]) = 
	\begin{bmatrix}
		R_t &   0 & 0\\
		  0 & R_t & 0\\
		  0 &   0 & R_n
	\end{bmatrix}
\end{eqnarray}
with $R_n^{-1} = dt^2k(1+\tau/dt)$ and $R_t=\sigma_t R_n$, where the
dimensionless parameter $\sigma_t$ allow us to control the amount of
regularization in the tangential direction.

In this case the convex set is the friction cone $\mathcal{C} = \mathcal{F}$ and
the projection can be computed in closed form as

\begin{equation}
	\bgamma = P_\mathcal{F}(\vf{y}) = 
\begin{dcases}
	% Region I, stiction
	\vf{y} 
	% When we  have:
	& \text{stiction, } y_r < \mu y_n\\
	%
	%
	% Region II, sliding.
	\begin{bmatrix}
		\mu\gamma_n\hat{\vf{t}}\\
		\frac{1}{1+\tilde\mu^2}\left(y_n +
	\mu\frac{R_t}{R_n}y_r\right)
	\end{bmatrix}
	% When we  have:
	& \text{sliding, } -\mu \frac{R_t}{R_n} y_r < y_n \leq \frac{y_r}{\mu}\\
	%
	%
	% Region III, no contact.
    \vf{0} & \text{no contact, } y_n \leq -\mu \frac{R_t}{R_n} y_r
\end{dcases}	  
	\label{eq:contact_projection}
\end{equation}
where $\vf{y}_t$ and $y_n$ are the tangential and normal components of $\vf{y}$,
the radial component is defined as $y_r=\Vert\vf{y}_t\Vert$ and the tangent
vector as $\hat{\vf{t}}=\vf{y}_t/y_r$. We also defined the common dimensionless
factors $\tilde\mu=\mu\,(R_t/R_n)^{1/2}$ and $\hat\mu=\mu\,R_t/R_n$.


\section{Rigid Contact}
\todo{explain how Todorov's choice leads to an unstable time stepping schem while this scheme is unconditionally stable.}

Todorov in \cite{bib:todorov2014} sets the regularization parameters as
$R_i=\varepsilon N_{ii}$, where $\varepsilon$ is a small dimensionless
coefficient that controls the amount of regularization. Higher regularization
makes the problem better conditioned though at the expense of large compliance
and a poor stiction approximation. Lower regularization will converge to the
\textit{hard constraints} limit, however leading to a poorly conditioned
formulation. 

In this work we choose $\varepsilon$ from an analysis of the time scales
introduced by this regularization. The basic idea is that if the time scales
introduced by this numerical compliance cannot be resolved by a given time step
size $dt$, the system is effectively rigid. It essentially makes no difference
on the results if regularization is decreased beyond this point. 

For each contact point we define $g_i=\Vert\mathbf{W}_{ii}\Vert/3$ where
$\mathbf{W}_{ii}$ is the $3\times 3$ diagonal block of the Delassus operator
$\mathbf{W}$. The factor $3$ in our definition is so that $g_i$ is the RMS value
of the entries of $\mathbf{W}_{ii}$. This definition ensures that $g_i > 0$.
$g_i$ has unit of $\text{kg}^{-1}$ and represents the inverse of an effective
mass $m_i=g_i^{-1}$ for the $i\text{-th}$ contact. For instance, for the contact
between a point mass $m$ and the ground we have $g_i=(3m)^{-1}$ and $m_i=3m$,
see Section \ref{sec:conveyor_belt}. 

Regularization in the normal direction introduces a numerical compliance of
stiffness $k$, see Section \ref{sec:physical_intuition}, and this will therefore
induce a dynamics with a natural frequency in the order of $\omega_n^2=k/m_i$.
This relates to the period $T_n$ of this dynamics by $\omega_n=2\pi/T_n$.

Since the time stepping scheme will not resolve time scales in the order or
below the time step $dt$, we want to choose our regularization parameters so
that the numerical dynamics introduced cannot be resolved. We then make $T_n =
\alpha dt$, with alpha $\alpha \approx 1.0$. Therefore we need for the stiffness
$k=4\pi^2m_i/(\alpha^2 dt^2)$. We learned in Section
\ref{sec:physical_intuition} that $R_n=(dt^2\,k)^{-1}$ and therefore we arrive
to the final expression for our regularization in the normal direction
\begin{equation}
	R_n = \frac{\alpha^2}{4\pi^2}g_i = \frac{\alpha^2}{4\pi^2}\Vert\mathbf{W}_{ii}\Vert
\end{equation}

This is the same as Todorov's regularization taking $\varepsilon =
\alpha^2/(4\pi^2)\approx 0.025\,\alpha^2$. This analysis shows us that:
\begin{itemize}
	\item We can use a single parameter $\varepsilon$, independent of the time
	step, that leads to essentially the same numerically introduced artificial
	dynamics. 
	\item When $\alpha=1.0$ we have $\varepsilon=0.025$ which introduces a fair
	amount of regularization into the system. However the numerical time scales
	are only within $dt$ and are underresolved, as desired.
\end{itemize}

It is useful to estimate the amount of penetration for a point mass resting on
the ground. In this case we have
\begin{eqnarray}
	\phi &=& \frac{m\,g}{k} \nonumber\\
	&=& \frac{\alpha^2}{4\pi^2}\frac{m}{m_i}\,g\,dt^2\nonumber\\
	&=& \frac{\alpha^2}{12\pi^2}\,g\,dt^2
\end{eqnarray}

Taking $\alpha=1.0$ and on Earth's gravity, a typical simulation time step of
$dt=10^{-3}~\text{s}$ leads to $\phi\approx 8.3\times 10^{-8}~\text{m}$ and
using a very large simulation time tep of $dt=10^{-2}~\text{s}$ leads to
$\phi\approx 8.3\times 10^{-6}~\text{m}$, well within acceptable bounds for
typical robotics applications.

There is another reason to choose $\alpha\approx 1.0$. As we will see in the
example of Section \ref{sec:conveyor_belt}, the numerical dynamics is close to
being critically damped and numerical oscillations due to regularization are
damped out within a few time steps, independent of step size (see Fig.
\ref{fig:normal_velocity}). This is an expected result if we consider the
stability analysis on an implicit Euler scheme, which resembles this formulation
very closely when we think of it as an implicit scheme on a multibody system
with the compliant forces  in Section \ref{sec:physical_intuition}. This is a
very desired effect for us being interested on robotics applications with
perfectly inelastic contact.

