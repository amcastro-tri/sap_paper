% Dummy comment for Reviewable.

\subsection{Two-Stage Scheme}
\label{sec:two_stage_scheme}

Similar to the work in \cite{bib:duriez2005realistic} for the simulation of
deformable objects and to projection methods used in fluid mechanics
\cite{bib::bell1991efficient}, we solve Eqs.
(\ref{eq:scheme_momentum})-(\ref{eq:scheme_q_update}) in two stages. In the
first stage, we solve for the \emph{free motion velocities} $\mf{v}^*$ the
system would have in the absence of contact constraints, according to
\begin{align}
	\mf{m}(\mf{v}^*) &= \mf{0},
	\label{eq:vstar_definition}
\end{align}
where we define the momentum residual $\mf{m}(\mf{v})$ from Eq.
(\ref{eq:scheme_momentum}) as
\begin{equation}
	\mf{m}(\mf{v}) =
	\mf{M}(\mf{q}^{\theta}(\mf{v}))(\mf{v}-\mf{v}_0) -
	\delta t\,\mf{k}(\mf{q}^{\theta}(\mf{v}), \mf{v}^{\theta}(\mf{v})).
	\label{eq:m_definition}
\end{equation}

For integration schemes that are implicit in $\mf{v}^*$ (e.g. the implicit Euler
scheme and the midpoint rule), we solve Eq. (\ref{eq:vstar_definition}) with
Newton's method. For schemes explicit in $\mf{v}^*$, only the mass matrix
$\mf{M}$ needs to be inverted, which can be accomplished efficiently using the
$\mathcal{O}(n)$ \emph{Articulated Body Algorithm}
\cite{bib:featherstone2008_rigid_body_dynamics_algorithms}.

The second stage solves a linear approximation of the balance of momentum in Eq.
(\ref{eq:scheme_momentum}) about $\mf{v}^*$ that satisfies the contact
constraints, Eqs. (\ref{eq:scheme_nonpenetration})-(\ref{eq:scheme_mdp_cone}). To write
a convex formulation of contact in Section \ref{sec:convex_approximation}, our
linearization uses a symmetric positive definite (SPD) approximation of
the Jacobian $\partial \mf{m}/\partial \mf{v}$. To achieve this, we split the
non-contact forces $\mf{k}$ in Eq. (\ref{eq:scheme_momentum}) as
\begin{equation*}
	\mf{k}(\mf{q}, \mf{v}) = \mf{k}_1(\mf{q}, \mf{v})+\mf{k}_2(\mf{q}, \mf{v}),
\end{equation*}
such that the Jacobians $\partial \mf{k}_1/\partial\mf{q}$ and $\partial
\mf{k}_1/\partial\mf{v}$ are negative definite matrices while the same is
generally not true for the Jacobians of $\mf{k}_2$. The term $\mf{k}_1(\mf{q},
\mf{v})$ can include forces from modeling elements such as spring and dampers.
The term $\mf{k}_2(\mf{q}, \mf{v})$ includes all other contributions that cannot
guarantee negative definiteness of their Jacobians, such as Coriolis and
gyroscopic forces arising in multibody dynamics with generalized coordinates. We
can now define the SPD approximation of $\partial \mf{m}/\partial \mf{v}$
evaluated at $\mf{v}^*$ as
\begin{align}
	\mf{A}&=\mf{M}+\delta t^2\,\theta\theta_{qv}\mf{K}+\delta t\,\theta\mf{D},
	\label{eq:expression_for_A}\\
	\mf{K}&=-\frac{\partial \mf{k}_1}{\partial
	\mf{q}}\frac{\partial\dot{\mf{q}}^{\theta_{vq}}}{\partial\mf{v}},
	\label{eq:stiffness_matrix}\\
	\mf{D}&=-\frac{\partial \mf{k}_1}{\partial\mf{v}},
	\label{eq:dissipation_matrix}
\end{align}
\reviewquestion{R4-Q3}{where $\mf{K} \succ 0$ and $\mf{D}\succ 0$ are the stiffness and damping
matrices of the system, respectively. For joint level
spring-dampers models, $\mf{K}$ and $\mf{D}$ are constant, diagonal, and
positive definite matrices. Section \ref{sec:spring_cylinder} shows the
performance of our scheme for a system with a linear spring.}

Using this SPD approximation of $\partial \mf{m}/\partial \mf{v}$, the
linearized balance of momentum \eqref{eq:scheme_momentum} reads
\begin{equation}
    % Momentum equation.
	\mf{A}(\mf{v}-\mf{v}^*) = \mf{J}^T\mf{\bgamma},
	\label{eq:momentum_linearized}
\end{equation}
where for convenience we use $\mf{J}$ as a shorthand to denote
$\mf{J}(\mf{q}_0)$. The approximation in Eq. (\ref{eq:momentum_linearized}) and
the original discrete momentum update in Eq. (\ref{eq:scheme_momentum}) agree to
second order as shown by the following result, proved in Appendix
\ref{app:gradient_of_m_approximation}.
\begin{prop}	
Matrix $\mf{A}$ is a first order approximation to the Jacobian of $\mf{m}$,
i.e.,
\begin{align*}
	\left. \frac{\partial \mf{m}}{\partial \mf{v}} \right|_{\mf{v}=\mf{v}^*} = \mf{A} + \mathcal{O}(\delta t).
\end{align*}
Therefore, Eq. (\ref{eq:momentum_linearized}) is a second order approximation of
the discrete balance of momentum in Eq. (\ref{eq:scheme_momentum}). Moreover,
$\mf{A} \succ 0$.
\label{prop:gradient_of_m_approximation}
\end{prop}

Notice that, in the absence of constraint impulses, the velocities at the next
time step are equal to the free motion velocities, i.e., $\mf{v}=\mf{v}^*$, and
they are computed with the order of accuracy of the $\theta\text{-method}$.
Furthermore, we also expect to recover the properties of the
$\theta\text{-method}$ when contact constraints are in stiction. As an example,
for bodies in contact that are under rolling friction, the contact constraints
behave as bi-lateral constraints that impose zero slip velocity. In this case,
our two stage method using the midpoint rule to compute $\mf{v}^*$ exhibits
considerably less numerical dissipation than first order methods. We demonstrate
this in Section \ref{sec:spring_cylinder} with an example of a mechanical system
with rolling friction.

Even after the linearization of the balance of momentum in Eq.
\eqref{eq:momentum_linearized}, the full problem with the contact constraints
\eqref{eq:scheme_nonpenetration}-\eqref{eq:scheme_mdp_cone} still consists of a
non-convex nonlinear complementarity problem (NCP). This kind of problems are
difficult to solve in practice, especially so in engineering applications for
which robustness and accuracy are required. In the next section we introduce a
number of approximations to this original NCP that allow us to make the problem
tractable and solve it efficiently in practice.
